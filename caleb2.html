<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blazing Turtles â€“ Dig Site Plant Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; background: #fdfdfd; }
    #map { height: 100vh; }
    h2 { margin: 8px 0 6px; color: #2c3e50; }
    h3 { margin: 15px 0 8px; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 4px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; margin: 4px 6px 0 0; }
    .row { margin: 12px 0; }
    label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 4px; }
    select, input[type="text"] { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    #selected-region { font-weight: bold; color: #007bff; }
    .plant-card { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .plant-card h3 { margin: 0 0 5px; color: #27ae60; border-bottom: none; }
    .plant-card p { margin: 4px 0; font-size: 0.9em; line-height: 1.4; }
    #results-count { margin: 15px 0 10px; font-weight: bold; color: #555; }
    #debug-panel { display:none; background:#f0f0f0; border:1px solid #ccc; padding:10px; font-family:monospace; font-size:12px; height:200px; overflow:auto; }
    #status { font-size: 11px; color: #888; margin-top: 4px; }
  </style>
</head>
<body>

<div id="wrap">
  <div id="sidebar">
    <h2>Blazing Turtles</h2>
    <p><em>Dig Site Plant Selector</em></p>
    <p style="font-size:0.9em;">Click a region on the map to see native plants for soil stability.</p>

    <div class="row">
      <strong>Region:</strong> <span id="selected-region">None (click map)</span>
    </div>

    <div class="row">
      <input type="text" id="search-box" placeholder="Search by name or species..." />
    </div>

    <h3>Filters</h3>
    
    <div class="row">
      <label for="type-filter">Plant Type</label>
      <select id="type-filter"><option value="all">All Types</option></select>
    </div>

    <div class="row">
      <label for="root-filter">Root Type (Stability)</label>
      <select id="root-filter"><option value="all">All Root Types</option></select>
    </div>

    <div class="row">
      <label for="moisture-filter">Soil Moisture</label>
      <select id="moisture-filter"><option value="all">All Moisture Levels</option></select>
    </div>

    <div class="row">
      <label for="sun-filter">Sun Exposure</label>
      <select id="sun-filter"><option value="all">All Exposure</option></select>
    </div>

    <div class="row">
      <label for="water-filter">Water Needs</label>
      <select id="water-filter"><option value="all">All Water Needs</option></select>
    </div>

    <div class="row">
      <label for="drought-filter">Drought Tolerance</label>
      <select id="drought-filter"><option value="all">All Tolerance Levels</option></select>
    </div>

    <div class="row">
      <label for="lifespan-filter">Lifespan</label>
      <select id="lifespan-filter"><option value="all">All Lifespans</option></select>
    </div>

    <div class="row">
      <label for="pollinator-filter">Pollinators</label>
      <select id="pollinator-filter"><option value="all">All Pollinators</option></select>
    </div>

    <hr/>
    <div id="results-count">Ready.</div>
    <div id="results-list"></div>

    <div id="status">Starting up...</div>
    <button onclick="openDebug()" style="margin-top:20px; font-size:10px;">Debug Tools</button>
    <div id="debug-panel" id="debug-log"></div>
  </div>

  <div id="map"></div>
</div>

<script>
  // ============================================================
  // Global State
  // ============================================================
  let plantData = null;
  let selectedL3Key = null;
  let selectedL3Name = null;

  // Constants - matching your file structure
  const ECOREGIONS_URL = 'us_eco_l3_state_boundaries.json';
  const DATABASE_CSV_URL = 'assets/Database-Deleted-Categories.csv';

  // Elements
  const elTypeFilter = document.getElementById('type-filter');
  const elSearch = document.getElementById('search-box');
  const elResults = document.getElementById('results-list');
  const elCount = document.getElementById('results-count');
  const elSelected = document.getElementById('selected-region');
  const elStatus = document.getElementById('status');
  const elDebug = document.getElementById('debug-panel');

  // ============================================================
  // Utilities
  // ============================================================
  function setStatus(msg) { elStatus.textContent = msg; }
  function logDebug(msg, obj) {
    const time = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.textContent = `[${time}] ${msg} ${obj ? JSON.stringify(obj) : ''}`;
    elDebug.appendChild(line);
    console.log(msg, obj);
  }
  function openDebug() { elDebug.style.display = 'block'; }

  function populateFilter(elementId, columnHeader, data, splitChar = ',') {
    const el = document.getElementById(elementId);
    if (!el) return;
    const values = new Set();
    data.forEach(p => {
      const val = p[columnHeader];
      if (val) {
        val.split(splitChar).forEach(v => {
          const trimmed = v.trim();
          if (trimmed && trimmed !== '0' && trimmed !== '-') values.add(trimmed);
        });
      }
    });
    const sorted = Array.from(values).sort();
    sorted.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
  }

  // ============================================================
  // Core Logic
  // ============================================================
  function renderResults() {
    if (!plantData) return;

    const searchVal = elSearch.value.toLowerCase();

    // Configuration for all category filters
    const filterConfig = [
      { id: 'type-filter', col: 'Plant Type', split: ',' },
      { id: 'moisture-filter', col: 'Soil Moisture', split: ',' },
      { id: 'sun-filter', col: 'SUN_EXPOSURE', split: ',' },
      { id: 'water-filter', col: 'WATER_NEEDS', split: ',' },
      { id: 'root-filter', col: 'ROOT_TYPE', split: ',' },
      { id: 'lifespan-filter', col: 'Lifespan', split: ',' },
      { id: 'drought-filter', col: 'Drought Tolerance', split: ',' },
      { id: 'pollinator-filter', col: 'Pollinators', split: ';' }
    ];

    elResults.innerHTML = '';

    const filtered = plantData.filter(p => {
      // 1. Region Filter
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;

      // 2. Category Filters
      for (const cfg of filterConfig) {
        const selectEl = document.getElementById(cfg.id);
        if (selectEl && selectEl.value !== 'all') {
          const plantVal = (p[cfg.col] || '');
          const parts = plantVal.split(cfg.split).map(s => s.trim());
          if (!parts.includes(selectEl.value)) return false;
        }
      }

      // 3. Search Filter
      const common = (p['Common Name'] || '').toLowerCase();
      const sci = (p['Scientific Name'] || '').toLowerCase();
      if (searchVal && !common.includes(searchVal) && !sci.includes(searchVal)) return false;

      return true;
    });

    elCount.textContent = selectedL3Key 
      ? `Found ${filtered.length} plants for ${selectedL3Name || selectedL3Key}`
      : `Found ${filtered.length} plants total (select a region)`;

    filtered.forEach(p => {
      const card = document.createElement('div');
      card.className = 'plant-card';
      card.innerHTML = `
        <h3>${p['Common Name'] || 'Unknown Plant'}</h3>
        <p><em>${p['Scientific Name'] || ''}</em></p>
        <p><strong>Type:</strong> ${p['Plant Type'] || '-'}</p>
        <p><strong>Roots:</strong> ${p['ROOT_TYPE'] || '-'} (${p['ROOT_DEPTH'] || 'Depth unknown'})</p>
        <p><strong>Moisture:</strong> ${p['Soil Moisture'] || '-'}</p>
        <p><strong>Sun:</strong> ${p['SUN_EXPOSURE'] || '-'}</p>
        <p><strong>Drought Tolerance:</strong> ${p['Drought Tolerance'] || '-'}</p>
        <p><a href="${p.SOURCE_LINK_1}" target="_blank" style="color:#007bff; text-decoration:none; font-weight:bold;">â†’ View Detailed Data</a></p>
      `;
      elResults.appendChild(card);
    });

    if (filtered.length === 0) {
      elResults.innerHTML = '<p style="color:#888; text-align:center; margin-top:20px;">No plants match these filters.</p>';
    }
  }

  // ============================================================
  // Data Loading
  // ============================================================
  async function loadPlantDatabaseCSV() {
    try {
      setStatus('Loading plant database...');
      const resp = await fetch(DATABASE_CSV_URL);
      if (!resp.ok) throw new Error('CSV file not found at ' + DATABASE_CSV_URL);
      const csvText = await resp.text();

      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          plantData = results.data;
          logDebug('âœ… CSV parsed', { count: plantData.length });
          
          // Populate all dynamic filters
          populateFilter('type-filter', 'Plant Type', plantData, ',');
          populateFilter('moisture-filter', 'Soil Moisture', plantData, ',');
          populateFilter('sun-filter', 'SUN_EXPOSURE', plantData, ',');
          populateFilter('water-filter', 'WATER_NEEDS', plantData, ',');
          populateFilter('root-filter', 'ROOT_TYPE', plantData, ',');
          populateFilter('lifespan-filter', 'Lifespan', plantData, ',');
          populateFilter('drought-filter', 'Drought Tolerance', plantData, ',');
          populateFilter('pollinator-filter', 'Pollinators', plantData, ';');

          setStatus(`Database loaded (${plantData.length} plants).`);
          renderResults();
        },
        error: (err) => { throw new Error('CSV Parse Error: ' + err.message); }
      });
    } catch (e) {
      logDebug('âŒ CSV load failed', String(e));
      setStatus('ERROR: Could not load plant CSV. Check the assets folder.');
    }
  }

  async function loadEcoregionsGeoJSON() {
    try {
      setStatus('Loading map...');
      const resp = await fetch(ECOREGIONS_URL);
      if (!resp.ok) throw new Error('GeoJSON file not found at ' + ECOREGIONS_URL);
      const geojson = await resp.json();

      const map = L.map('map').setView([37.8, -96], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      function onEachFeature(feature, layer) {
        layer.setStyle({ color: '#27ae60', weight: 1, fillOpacity: 0.2 });
        layer.on('mouseover', () => layer.setStyle({ fillOpacity: 0.5 }));
        layer.on('mouseout', () => layer.setStyle({ fillOpacity: 0.2 }));
        
        layer.on('click', () => {
          const p = feature.properties || {};
          selectedL3Key = p.L3_KEY || null;
          selectedL3Name = p.US_L3NAME || p.NA_L3NAME || null;

          elSelected.textContent = selectedL3Key
            ? (selectedL3Name ? `${selectedL3Key} â€” ${selectedL3Name}` : selectedL3Key)
            : 'Unknown region';

          logDebug('ðŸ—ºï¸ region clicked', { selectedL3Key, selectedL3Name });
          renderResults();
        });
      }

      L.geoJSON(geojson, { onEachFeature }).addTo(map);
      setStatus('Map loaded. Click an ecoregion!');
    } catch (e) {
      logDebug('âŒ Map failed', String(e));
      setStatus('ERROR: Could not load map GeoJSON.');
    }
  }

  // ============================================================
  // Boot
  // ============================================================
  (async function start() {
    logDebug('ðŸš€ App starting...');
    
    // Add Event Listeners for search and all filters
    elSearch.addEventListener('input', renderResults);
    const filterIds = ['type-filter', 'moisture-filter', 'sun-filter', 'water-filter', 'root-filter', 'lifespan-filter', 'drought-filter', 'pollinator-filter'];
    filterIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', renderResults);
    });

    await loadEcoregionsGeoJSON();
    await loadPlantDatabaseCSV();
  })();

</script>
</body>
</html>