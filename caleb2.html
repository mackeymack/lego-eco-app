<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-green: #1a5d1a;
      --accent-green: #27ae60;
      --bg-light: #f8fafc;
      --border-color: #e2e8f0;
      --text-main: #2d3436;
      --soft-radius: 12px;
    }

    body { margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text-main); line-height: 1.5; }
    #wrap { display: grid; grid-template-columns: 440px 1fr; height: 100vh; }
    
    #sidebar { padding: 30px; border-right: 1px solid var(--border-color); overflow-y: auto; background: white; z-index: 10; scroll-behavior: smooth; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    
    /* Typography */
    h2 { margin: 0 0 4px; color: var(--primary-green); font-size: 2.4em; letter-spacing: -1px; font-weight: 800; }
    .acronym { font-size: 0.8em; color: var(--accent-green); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .subtitle { margin-bottom: 30px; color: #94a3b8; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
    
    #secret-dot { cursor: pointer; user-select: none; transition: opacity 0.2s; }
    #secret-dot:hover { opacity: 0.7; }

    h3 { margin: 35px 0 15px; font-size: 0.9em; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; color: #475569; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Buttons & Inputs */
    .btn-standard { 
      width: 100%; border: none; padding: 14px; border-radius: var(--soft-radius); 
      font-weight: 700; cursor: pointer; transition: all 0.2s ease; 
      display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em;
    }
    
    #geo-btn { background: #3b82f6; color: white; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2); }
    #geo-btn:hover { background: #2563eb; transform: translateY(-1px); }

    .zip-container { display: flex; gap: 10px; margin-bottom: 12px; }
    input[type="text"], input[type="number"], select { 
      flex-grow: 1; padding: 12px; border: 1.5px solid var(--border-color); 
      border-radius: var(--soft-radius); font-size: 0.9em; height: 48px; 
      box-sizing: border-box; transition: border-color 0.2s; background: #fff;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent-green); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1); }

    .action-btn { background: var(--accent-green); color: white; border: none; padding: 0 24px; border-radius: var(--soft-radius); font-weight: 700; cursor: pointer; height: 48px; transition: background 0.2s; }
    .action-btn:hover { background: #1e8449; }

    .export-btn { 
      flex: 1; padding: 12px; border-radius: var(--soft-radius); border: 1.5px solid var(--accent-green); 
      background: white; color: var(--accent-green); font-weight: 700; cursor: pointer; font-size: 0.8em; transition: all 0.2s;
    }
    .export-btn:hover { background: var(--accent-green); color: white; }

    /* Filters */
    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    label { font-weight: 700; font-size: 0.7em; display: block; margin-bottom: 8px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .region-display-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    #selected-region { 
      flex-grow: 1; font-weight: 700; color: #1e40af; background: #eff6ff; 
      padding: 12px; border-radius: var(--soft-radius); font-size: 0.85em; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 48px; 
      display: flex; align-items: center; border: 1px solid #dbeafe;
    }
    #clear-selection-btn { background: #fee2e2; color: #b91c1c; border: none; padding: 0 16px; border-radius: var(--soft-radius); font-weight: 700; cursor: pointer; height: 48px; font-size: 0.8em; }

    .reset-filters-btn { width: 100%; background: #f1f5f9; border: none; color: #64748b; padding: 12px; border-radius: var(--soft-radius); font-size: 0.85em; font-weight: 700; cursor: pointer; margin-top: 10px; margin-bottom: 25px; }
    .reset-filters-btn:hover { background: #e2e8f0; }

    /* Plant Cards */
    .plant-card { border: 1px solid var(--border-color); padding: 20px; margin-bottom: 20px; border-radius: var(--soft-radius); background: #fff; transition: transform 0.2s, box-shadow 0.2s; }
    .plant-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
    .plant-card h4 { margin: 0 0 6px; color: var(--text-main); font-size: 1.25em; font-weight: 800; }
    .plant-card p { margin: 8px 0; font-size: 0.9em; color: #475569; }
    .plant-card strong { color: #1e293b; font-weight: 600; }
    
    .plant-img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; margin: 12px 0 8px; background: #f8fafc; }
    .img-caption { font-size: 0.75em; color: #94a3b8; display: block; margin-bottom: 15px; }

    .source-link { display: inline-block; color: var(--accent-green); text-decoration: none; font-weight: 700; font-size: 0.8em; border: 1.5px solid var(--accent-green); padding: 8px 16px; border-radius: 8px; transition: all 0.2s; }
    .source-link:hover { background: var(--accent-green); color: white; }
    .more-info-btn { background: #f8fafc; border: 1.5px solid #e2e8f0; color: #64748b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.8em; font-weight: 700; }
    .more-info-btn:hover { background: #f1f5f9; }

    .details-pane { display: none; margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color); font-size: 0.85em; color: #475569; }
    .details-pane.active { display: block; }
    .details-pane div { margin-bottom: 8px; display: flex; justify-content: space-between; }
    .details-pane strong { color: #64748b; font-weight: 600; font-size: 0.8em; text-transform: uppercase; }

    /* Footer & System Info */
    #results-count { margin: 20px 0; font-weight: 800; font-size: 1em; color: var(--accent-green); text-align: center; background: #f0fdf4; padding: 10px; border-radius: 8px; }
    #status { font-size: 11px; color: #94a3b8; text-align: center; margin-top: 10px; font-weight: 600; }

    #debug-overlay {
      display: none; position: fixed; top: 10%; left: 10%; right: 10%; bottom: 10%;
      background: #0f172a; color: #10b981; font-family: 'Fira Code', monospace; padding: 25px; z-index: 10000;
      border: 1px solid #334155; border-radius: var(--soft-radius); flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .leaflet-tooltip-custom { background: rgba(15, 23, 42, 0.95); color: white; border: none; font-weight: 600; padding: 12px 16px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
  </style>
</head>
<body>

<div id="debug-overlay">
  <div class="debug-toolbar" style="display:flex; justify-content: space-between; margin-bottom: 15px;">
    <span style="font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">S.P.A.D.E. Core System</span>
    <div style="display: flex; gap: 10px;">
      <button class="debug-btn" onclick="copyDebugLog()">Copy</button>
      <button class="debug-btn" onclick="clearDebugLog()">Clear</button>
      <button class="debug-btn close-btn" style="background:#ef4444;" onclick="document.getElementById('debug-overlay').style.display = 'none'">Close</button>
    </div>
  </div>
  <div id="debug-content" style="flex-grow:1; overflow-y:auto; background:#1e293b; padding:15px; border-radius:8px; font-size:12px;"></div>
</div>

<div id="wrap">
  <div id="sidebar">
    <h2>S<span id="secret-dot">.</span>P.A.D.E.</h2>
    <div class="acronym">Site Preservation & Dirt Erosion</div>
    <div class="subtitle">By the Blazin Turtles</div>
    
    <button id="geo-btn" class="btn-standard" onclick="useMyLocation()">üìç Use My Location</button>

    <div class="zip-container">
      <input type="text" id="zip-input" placeholder="Zip Code" maxlength="5">
      <button class="action-btn" onclick="useZipCode()">Go</button>
    </div>

    <div class="zip-container">
      <input type="number" id="lat-input" placeholder="Lat" step="any">
      <input type="number" id="lng-input" placeholder="Lng" step="any">
      <button class="action-btn" onclick="useCoordinates()" style="background: #3b82f6;">Go</button>
    </div>

    <div class="row">
      <label>Target Ecoregion</label>
      <div class="region-display-container">
        <div id="selected-region">Select a site on the map</div>
        <button id="clear-selection-btn" onclick="resetSelection()">Clear</button>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <label for="search-box">Search Plants</label>
      <input type="text" id="search-box" placeholder="e.g. Oak, Sagebrush..." />
    </div>

    <h3>Environment & Season</h3>
    <div class="filter-grid">
      <div class="row"><label>Plant Type</label><select id="type-filter" class="plant-filter"><option value="all">Any Type</option></select></div>
      <div class="row"><label>Root Type</label><select id="root-filter" class="plant-filter"><option value="all">Any Root</option></select></div>
      <div class="row"><label>Moisture</label><select id="moisture-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Sun</label><select id="sun-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Drought Tol.</label><select id="drought-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Fire Tol.</label><select id="fire-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Growth</label><select id="growth-filter" class="plant-filter"><option value="all">Any Period</option></select></div>
      <div class="row">
        <label>Season</label>
        <select id="season-filter" class="plant-filter">
          <option value="all">Any Season</option>
          <option value="Spring">Spring</option>
          <option value="Fall">Fall</option>
          <option value="Summer">Summer</option>
          <option value="Winter">Winter</option>
          <option value="Year Round">Year Round</option>
        </select>
      </div>
    </div>

    <h3>Soil Analysis</h3>
    <div class="filter-grid">
      <div class="row"><label>Clay</label><select id="clay-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Sand</label><select id="sand-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Gravel</label><select id="gravel-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Loam</label><select id="loam-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Silt</label><select id="silt-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Peat</label><select id="peat-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Chalky</label><select id="chalky-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
    </div>

    <button class="reset-filters-btn" onclick="resetFilters()">Reset All Filters</button>

    <div id="results-count">Ready to scan...</div>

    <div class="export-row">
      <button class="export-btn" onclick="exportExcel()">Export (XLSX)</button>
      <button class="export-btn" onclick="exportSheets()">Export (Sheets)</button>
    </div>

    <div id="results-list"></div>
    <div id="show-more-container">
      <button id="show-more-btn" class="action-btn" style="width:100%;" onclick="showMore()">Show More Results</button>
    </div>
    
    <div id="status">Initializing...</div>
  </div>

  <div id="map-container"><div id="map"></div></div>
</div>

<script>
  let plantData = null, currentFilteredItems = [], selectedL3Key = null, regionCounts = {}, displayLimit = 10, map, geoLayer; 
  const increment = 10, ECO_URL = 'assets/us_eco_l3_state_boundaries.json', CSV_URL = 'assets/Database-Deleted-Categories.csv';

  const vendorLinkMap = {
    "native west": { name: "Native West Nursery", url: "https://nativewest.com/" },
    "prairie moon nursery": { name: "Prairie Moon Nursery", url: "https://www.prairiemoon.com/" },
    "praire nursery": { name: "Prairie Nursery", url: "https://www.prairienursery.com/" },
    "ernst seeds": { name: "Ernst Conservation Seeds", url: "https://www.ernstseed.com/" },
    "gbnp": { name: "Great Bear Native Plants", url: "http://www.greatbearnativeplants.com/" },
    "mellow marsh farm": { name: "Mellow Marsh Farm", url: "https://mellowmarshfarm.com/" },
    "roots and shoots": { name: "Roots and Shoots Nursery", url: "https://www.rootsandshootsnursery.com/" },
    "critsite_native_plants_full_list": { name: "Plant Picker", url: "https://plantsman.com/" }
  };

  let dotClickCount = 0, dotTimer;
  document.getElementById('secret-dot').addEventListener('click', () => {
    dotClickCount++;
    clearTimeout(dotTimer);
    if (dotClickCount === 2) {
      if (prompt("Enter System Key:") === "numpy") {
        document.getElementById('debug-overlay').style.display = 'flex';
        sysLog("Core System Accessed.");
      }
      dotClickCount = 0;
    } else {
      dotTimer = setTimeout(() => { dotClickCount = 0; }, 500);
    }
  });

  function sysLog(msg) {
    const content = document.getElementById('debug-content');
    if(content) {
        content.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        content.scrollTop = content.scrollHeight;
    }
  }

  function clearDebugLog() { document.getElementById('debug-content').innerHTML = ''; sysLog("Logs purged."); }
  function copyDebugLog() { navigator.clipboard.writeText(document.getElementById('debug-content').innerText); alert("Logs copied."); }

  function showMore() { displayLimit += increment; renderResults(false); }

  function populate(id, col, data) {
    const sel = document.getElementById(id), vals = new Set();
    data.forEach(r => { if(r[col] && r[col] !== '0') r[col].split(',').forEach(v => vals.add(v.trim())); });
    Array.from(vals).sort().forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
  }

  function highlightRegion(key) {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      if (layer.feature.properties.L3_KEY === key) {
        layer.setStyle({ fillOpacity: 0.6, weight: 3, color: '#1a5d1a', opacity: 1 });
        layer.bringToFront();
      } else {
        layer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#27ae60', opacity: 0.3 });
      }
    });
  }

  function resetFilters() {
    document.getElementById('search-box').value = "";
    document.querySelectorAll('.plant-filter').forEach(s => s.value = 'all');
    renderResults(true);
  }

  function resetSelection() {
    selectedL3Key = null;
    document.getElementById('selected-region').textContent = "Select a site on the map";
    ['zip-input', 'lat-input', 'lng-input'].forEach(id => document.getElementById(id).value = "");
    if (geoLayer) geoLayer.eachLayer(layer => layer.setStyle({ fillOpacity: 0.1, weight: 1, color: '#27ae60', opacity: 1 }));
    map.setView([37.8, -96], 4);
    renderResults(true);
  }

  async function loadPlantPhoto(sciName, idx, source1) {
    const img = document.getElementById(`img-${idx}`);
    const caption = document.getElementById(`caption-${idx}`);
    try {
      const res = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(sciName)}&rank=species`);
      const data = await res.json();
      if (data.results && data.results.length > 0 && data.results[0].default_photo) {
        img.src = data.results[0].default_photo.medium_url;
        caption.textContent = `Source: iNaturalist (USDA Designation)`;
      } else {
        img.style.display = 'none';
        caption.style.display = 'none';
      }
    } catch (e) { 
      img.style.display = 'none'; 
    }
  }

  function renderResults(resetLimit = true) {
    if (!plantData) return;
    if (resetLimit) displayLimit = 10;

    const query = document.getElementById('search-box').value.toLowerCase();
    const f = {
      type: document.getElementById('type-filter').value,
      root: document.getElementById('root-filter').value,
      moisture: document.getElementById('moisture-filter').value,
      sun: document.getElementById('sun-filter').value,
      drought: document.getElementById('drought-filter').value,
      fire: document.getElementById('fire-filter').value,
      growth: document.getElementById('growth-filter').value,
      season: document.getElementById('season-filter').value,
      clay: document.getElementById('clay-filter').value,
      sand: document.getElementById('sand-filter').value,
      gravel: document.getElementById('gravel-filter').value,
      loam: document.getElementById('loam-filter').value,
      silt: document.getElementById('silt-filter').value,
      peat: document.getElementById('peat-filter').value,
      chalky: document.getElementById('chalky-filter').value
    };

    currentFilteredItems = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (f.type !== 'all' && !(p['Plant Type'] || '').includes(f.type)) return false;
      if (f.root !== 'all' && !(p['ROOT_TYPE'] || '').includes(f.root)) return false;
      if (f.moisture !== 'all' && !(p['Soil Moisture'] || '').includes(f.moisture)) return false;
      if (f.sun !== 'all' && !(p['SUN_EXPOSURE'] || '').includes(f.sun)) return false;
      if (f.drought !== 'all' && !(p['Drought Tolerance'] || '').includes(f.drought)) return false;
      if (f.fire !== 'all' && !(p['Fire Tolerance'] || '').includes(f.fire)) return false;
      if (f.growth !== 'all' && !(p['Active Growth Period'] || '').includes(f.growth)) return false;
      
      if (f.season !== 'all') {
        const sVal = (p['PLANTING_SEASON'] || '').toLowerCase();
        if (f.season === 'Year Round') {
          if (!(sVal.includes('spring') && sVal.includes('fall') && sVal.includes('summer') && sVal.includes('winter'))) return false;
        } else if (!sVal.includes(f.season.toLowerCase())) {
          return false;
        }
      }

      if (f.clay !== 'all' && p['CLAY_SOIL'] !== f.clay) return false;
      if (f.sand !== 'all' && p['SAND_SOIL'] !== f.sand) return false;
      if (f.gravel !== 'all' && p['GRAVEL_SOIL'] !== f.gravel) return false;
      if (f.loam !== 'all' && p['LOAM_SOIL'] !== f.loam) return false;
      if (f.silt !== 'all' && p['SILT_SOIL'] !== f.silt) return false;
      if (f.peat !== 'all' && p['PEAT_SOIL'] !== f.peat) return false;
      if (f.chalky !== 'all' && p['CHALKY_SOIL'] !== f.chalky) return false;
      if (query && !((p['Common Name'] || '').toLowerCase().includes(query) || (p['Scientific Name'] || '').toLowerCase().includes(query))) return false;
      return true;
    });

    document.getElementById('results-count').textContent = `Matched ${currentFilteredItems.length} Plant Species`;
    document.getElementById('show-more-container').style.display = (currentFilteredItems.length > displayLimit) ? 'block' : 'none';

    const list = document.getElementById('results-list');
    list.innerHTML = '';
    currentFilteredItems.slice(0, displayLimit).forEach((p, index) => {
      const card = document.createElement('div');
      card.className = 'plant-card';
      
      let soils = [];
      ['CLAY','SAND','GRAVEL','LOAM','SILT','PEAT','CHALKY'].forEach(s => { if(p[s+'_SOIL'] === 'Yes') soils.push(s.charAt(0)+s.slice(1).toLowerCase()); });
      const soilStr = soils.length > 0 ? soils.join(', ') : 'Versatile';

      const vRaw = p['Vendor'] || 'None';
      const vKey = vRaw.toLowerCase().trim();
      const vInfo = vendorLinkMap[vKey] || null;
      const vendorHtml = vInfo ? `<a href="${vInfo.url}" target="_blank" style="color:var(--accent-green); text-decoration:none;">${vInfo.name}</a>` : vRaw;

      let detailsHtml = '';
      Object.keys(p).forEach(k => { if(p[k] && p[k] !== '0') detailsHtml += `<div><strong>${k.replace(/_/g,' ')}</strong><span>${p[k]}</span></div>`; });

      card.innerHTML = `
        <h4>${p['Common Name'] || 'Native Species'}</h4>
        <p><em>${p['Scientific Name'] || ''}</em></p>
        <img id="img-${index}" class="plant-img" src="" alt="">
        <span id="caption-${index}" class="img-caption"></span>
        <p><strong>Roots:</strong> ${p['ROOT_TYPE'] || 'N/A'} (${p['ROOT_DEPTH'] || 'N/A'})</p>
        <p><strong>Nursery:</strong> ${vendorHtml}</p>
        <p><strong>Soil:</strong> ${soilStr}</p>
        <p><strong>Sun:</strong> ${p['SUN_EXPOSURE'] || 'N/A'}</p>
        <div class="card-actions">
          <button id="btn-${index}" class="more-info-btn" onclick="toggleDetails(${index})">Details</button>
          <a href="${p['SOURCE_LINK_1']}" target="_blank" class="source-link">USDA Profile</a>
        </div>
        <div id="details-${index}" class="details-pane">${detailsHtml}</div>
      `;
      list.appendChild(card);
      loadPlantPhoto(p['Scientific Name'], index, p['SOURCE_LINK_1']);
    });
  }

  async function useZipCode() {
    const zip = document.getElementById('zip-input').value;
    if (!/^\d{5}$/.test(zip)) return;
    try {
      const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
      const data = await res.json();
      const lat = parseFloat(data.places[0].latitude), lng = parseFloat(data.places[0].longitude);
      document.getElementById('lat-input').value = lat;
      document.getElementById('lng-input').value = lng;
      matchLocationToRegion(lat, lng);
    } catch (err) { sysLog("ZIP resolution failed."); }
  }

  async function useMyLocation() {
    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        document.getElementById('lat-input').value = lat.toFixed(4);
        document.getElementById('lng-input').value = lng.toFixed(4);
        matchLocationToRegion(lat, lng);
      }, (err) => sysLog("GPS unavailable."));
  }

  function useCoordinates() {
    const lat = parseFloat(document.getElementById('lat-input').value), lng = parseFloat(document.getElementById('lng-input').value);
    if (!isNaN(lat) && !isNaN(lng)) matchLocationToRegion(lat, lng);
  }

  function matchLocationToRegion(lat, lng) {
    const results = leafletPip.pointInLayer([lng, lat], geoLayer);
    if (results.length > 0) {
      const f = results[0].feature;
      selectedL3Key = f.properties.L3_KEY;
      document.getElementById('selected-region').textContent = `${selectedL3Key}: ${f.properties.US_L3NAME}`;
      map.setView([lat, lng], 8);
      highlightRegion(selectedL3Key);
      renderResults(true);
    }
  }

  async function init() {
    Papa.parse(CSV_URL, { download: true, header: true, complete: (res) => {
        plantData = res.data;
        plantData.forEach(p => { if(p.L3_KEY) regionCounts[p.L3_KEY] = (regionCounts[p.L3_KEY] || 0) + 1; });
        ['type-filter', 'root-filter', 'moisture-filter', 'sun-filter', 'drought-filter', 'fire-filter', 'growth-filter'].forEach(id => {
          const col = id === 'type-filter' ? 'Plant Type' : id === 'root-filter' ? 'ROOT_TYPE' : id === 'moisture-filter' ? 'Soil Moisture' : id === 'sun-filter' ? 'SUN_EXPOSURE' : id === 'drought-filter' ? 'Drought Tolerance' : id === 'fire-filter' ? 'Fire Tolerance' : 'Active Growth Period';
          populate(id, col, plantData);
        });
        document.getElementById('status').textContent = 'Live ‚Ä¢ v3.2';
        renderResults();
        loadMap();
    }});
  }

  async function loadMap() {
    map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    try {
      const geoRes = await fetch(ECO_URL);
      const geoJSON = await geoRes.json();
      const eStates = {};
      geoJSON.features.forEach(f => {
        const k = f.properties.L3_KEY;
        const s = f.properties.STATE_NAME || f.properties.STATE || "";
        if (k && s) { if (!eStates[k]) eStates[k] = new Set(); eStates[k].add(s); }
      });

      geoLayer = L.geoJSON(geoJSON, {
        style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
          const key = f.properties.L3_KEY;
          const sList = eStates[key] ? Array.from(eStates[key]).sort().join(', ') : "USA";
          l.bindTooltip(`<div style="font-size:14px"><b>${key}:</b> ${f.properties.US_L3NAME}<br/>${regionCounts[key] || 0} Species ‚Ä¢ ${sList}</div>`, { sticky: true, className: 'leaflet-tooltip-custom' });
          l.on({ 
            mouseover: (e) => e.target.setStyle({ fillOpacity: 0.3 }),
            mouseout: (e) => e.target.setStyle({ fillOpacity: 0.1 }),
            click: (e) => {
              selectedL3Key = key;
              document.getElementById('selected-region').textContent = `${key}: ${f.properties.US_L3NAME}`;
              highlightRegion(key);
              renderResults(true);
          }});
        }
      }).addTo(map);
    } catch (e) { sysLog("Map engine failure."); }
  }

  function toggleDetails(idx) { 
    const pane = document.getElementById(`details-${idx}`);
    const btn = document.getElementById(`btn-${idx}`);
    pane.classList.toggle('active');
    btn.textContent = pane.classList.contains('active') ? 'Less' : 'Details';
  }
  document.querySelectorAll('select, input').forEach(el => el.addEventListener('change', () => renderResults(true)));
  window.onload = init;
</script>

</body>
</html>