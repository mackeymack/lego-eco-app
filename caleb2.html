<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #2d3436; }
    #wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    
    #sidebar { padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    
    h2 { margin: 0 0 2px; color: #1a5d1a; font-size: 2.2em; letter-spacing: 2px; }
    .acronym { font-size: 0.85em; color: #27ae60; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; }
    .subtitle { margin-bottom: 20px; color: #636e72; font-weight: bold; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
    
    h3 { margin: 25px 0 10px; font-size: 1em; border-bottom: 2px solid #27ae60; padding-bottom: 5px; color: #27ae60; text-transform: uppercase; }
    
    #geo-btn { 
      width: 100%; background: #2980b9; color: white; border: none; padding: 12px; 
      border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
    }

    .zip-container { display: flex; gap: 5px; margin-bottom: 15px; }
    #zip-input { flex-grow: 1; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; }
    #zip-btn { background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }

    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { margin-bottom: 12px; }
    label { font-weight: bold; font-size: 0.8em; display: block; margin-bottom: 4px; color: #4b4b4b; }
    select, input[type="text"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.85em; }
    
    .region-display-container { display: flex; align-items: center; gap: 8px; }
    #selected-region { flex-grow: 1; font-weight: bold; color: #2980b9; background: #e1f0fa; padding: 8px; border-radius: 6px; font-size: 0.85em; }
    
    .plant-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; border-left: 5px solid #27ae60; position: relative; }
    .plant-card.invasive { border-left: 5px solid #e74c3c; background: #fff5f5; }
    .invasive-badge { position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; font-size: 0.7em; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }

    .export-row { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
    .export-btn { flex: 1; min-width: 120px; padding: 10px; border-radius: 6px; border: 1px solid #27ae60; background: white; color: #27ae60; font-weight: bold; cursor: pointer; font-size: 0.75em; }
    .export-btn:hover { background: #27ae60; color: white; }
    .print-btn { background: #27ae60; color: white; }

    /* Print Styling for Feature 10 */
    @media print {
      #sidebar, #map-container, #debug-trigger, .card-actions, #show-more-container, .export-row, .reset-filters-btn { display: none !important; }
      body { background: white; }
      #wrap { display: block; height: auto; }
      #results-list { width: 100%; }
      .plant-card { border: 1px solid #ccc; page-break-inside: avoid; margin-bottom: 20px; }
      .details-pane { display: block !important; }
      #results-count::before { content: "S.P.A.D.E. Site Prescription Report\n"; font-size: 24px; font-weight: bold; display: block; margin-bottom: 10px; color: #1a5d1a; }
    }

    .details-pane { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.8em; }
    .details-pane.active { display: block; }
  </style>
</head>
<body>

<div id="wrap">
  <div id="sidebar">
    <h2>S.P.A.D.E.</h2>
    <div class="acronym">SITE PRESERVATION AND DIRT EROSION-CONTROL</div>
    
    <button id="geo-btn" onclick="useMyLocation()">üìç Use My Current Location</button>

    <div class="zip-container">
      <input type="text" id="zip-input" placeholder="Enter Zip Code" maxlength="5">
      <button id="zip-btn" onclick="useZipCode()">Go</button>
    </div>

    <div class="row">
      <label>Target Ecoregion</label>
      <div class="region-display-container">
        <div id="selected-region">Click map or use location</div>
      </div>
    </div>

    <h3>Stability & Growth</h3>
    <div class="filter-grid">
      <div class="row"><label>Plant Type</label><select id="type-filter" class="plant-filter"><option value="all">Any Type</option></select></div>
      <div class="row"><label>Pollinator/Host</label><select id="pollinator-filter" class="plant-filter"><option value="all">Any Pollinator</option></select></div>
      <div class="row"><label>Drought Tol.</label><select id="drought-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Fire Tol.</label><select id="fire-filter" class="plant-filter"><option value="all">Any</option></select></div>
    </div>

    <button class="export-btn" style="width:100%; margin-bottom:10px;" onclick="resetFilters()">Reset All Filters</button>

    <div id="results-count"></div>

    <div class="export-row">
      <button class="export-btn" onclick="exportExcel()">Excel</button>
      <button class="export-btn print-btn" onclick="window.print()">Print Prescription</button>
    </div>

    <div id="results-list"></div>
    <div id="show-more-container"><button id="show-more-btn" onclick="showMore()">Show More</button></div>
  </div>

  <div id="map-container"><div id="map"></div></div>
</div>

<script>
  let plantData = null, currentFilteredItems = [], selectedL3Key = null, regionCounts = {}, displayLimit = 10;
  const mapCenter = [37.8, -96], ECO_URL = 'assets/us_eco_l3_state_boundaries.json', CSV_URL = 'assets/Database-Deleted-Categories.csv';

  function populate(id, col, data) {
    const sel = document.getElementById(id), vals = new Set();
    data.forEach(r => { if(r[col] && r[col] !== '0') r[col].split(';').forEach(v => vals.add(v.trim())); });
    Array.from(vals).sort().forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
  }

  function resetFilters() {
    document.querySelectorAll('.plant-filter').forEach(s => s.value = 'all');
    renderResults(true);
  }

  function renderResults(resetLimit = true) {
    if (!plantData) return;
    if (resetLimit) displayLimit = 10;

    const f = {
      type: document.getElementById('type-filter').value,
      pollinator: document.getElementById('pollinator-filter').value,
      drought: document.getElementById('drought-filter').value,
      fire: document.getElementById('fire-filter').value
    };

    currentFilteredItems = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (f.type !== 'all' && !(p['Plant Type'] || '').includes(f.type)) return false;
      if (f.pollinator !== 'all' && !(p['Pollinators'] || '').includes(f.pollinator)) return false;
      if (f.drought !== 'all' && !(p['Drought Tolerance'] || '').includes(f.drought)) return false;
      if (f.fire !== 'all' && !(p['Fire Tolerance'] || '').includes(f.fire)) return false;
      return true;
    });

    document.getElementById('results-count').textContent = `Matches: ${currentFilteredItems.length}`;
    const list = document.getElementById('results-list');
    list.innerHTML = '';
    
    currentFilteredItems.slice(0, displayLimit).forEach((p, index) => {
      const isInvasive = p['INVASIVE'] === 'Yes';
      const card = document.createElement('div');
      card.className = `plant-card ${isInvasive ? 'invasive' : ''}`;
      card.innerHTML = `
        ${isInvasive ? '<div class="invasive-badge">Invasive Warning</div>' : ''}
        <h4>${p['Common Name'] || 'Unknown'}</h4>
        <p><em>${p['Scientific Name'] || ''}</em></p>
        <p><strong>Pollinators:</strong> ${p['Pollinators'] || 'N/A'}</p>
        <p><strong>Roots:</strong> ${p['ROOT_TYPE'] || 'N/A'} (${p['ROOT_DEPTH'] || 'N/A'})</p>
        <div class="card-actions">
           <button class="export-btn" onclick="document.getElementById('details-${index}').classList.toggle('active')">Info</button>
           ${p['SOURCE_LINK_1'] !== '0' ? `<a href="${p['SOURCE_LINK_1']}" target="_blank" class="export-btn" style="text-decoration:none; text-align:center">Link</a>` : ''}
        </div>
        <div id="details-${index}" class="details-pane">
          <div><strong>Growth Period:</strong> ${p['Active Growth Period'] || 'N/A'}</div>
          <div><strong>Sun:</strong> ${p['SUN_EXPOSURE'] || 'N/A'}</div>
          <div><strong>Moisture:</strong> ${p['Soil Moisture'] || 'N/A'}</div>
        </div>
      `;
      list.appendChild(card);
    });
  }

  async function init() {
    Papa.parse(CSV_URL, {
      download: true, header: true,
      complete: (res) => {
        plantData = res.data;
        plantData.forEach(p => { if(p.L3_KEY) regionCounts[p.L3_KEY] = (regionCounts[p.L3_KEY] || 0) + 1; });
        populate('type-filter', 'Plant Type', plantData);
        populate('pollinator-filter', 'Pollinators', plantData);
        populate('drought-filter', 'Drought Tolerance', plantData);
        populate('fire-filter', 'Fire Tolerance', plantData);
        renderResults();
        loadMap();
      }
    });
  }

  async function loadMap() {
    let map = L.map('map').setView(mapCenter, 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const geoRes = await fetch(ECO_URL);
    const geoJSON = await geoRes.json();
    L.geoJSON(geoJSON, {
      style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 },
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedL3Key = f.properties.L3_KEY;
          document.getElementById('selected-region').textContent = f.properties.US_L3NAME;
          renderResults(true);
        });
      }
    }).addTo(map);
  }

  document.querySelectorAll('.plant-filter').forEach(el => el.addEventListener('change', () => renderResults(true)));
  window.onload = init;
</script>

</body>
</html>