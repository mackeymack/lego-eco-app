<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. â€“ by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.1.0/turf.min.js"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #2d3436; }
    #wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    #sidebar { padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    #debug-trigger { cursor: default; user-select: none; }
    h2 { margin: 0 0 2px; color: #1a5d1a; font-size: 2.2em; letter-spacing: 2px; }
    .acronym { font-size: 0.85em; color: #27ae60; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; }
    .subtitle { margin-bottom: 20px; color: #636e72; font-weight: bold; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
    #gps-btn { margin-top: 10px; width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: bold; transition: background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #gps-btn:hover { background: #1e8449; }
    #selected-region { font-weight: bold; color: #2980b9; background: #e1f0fa; padding: 8px; border-radius: 6px; font-size: 0.9em; }
    .plant-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; border-left: 5px solid #27ae60; }
    .card-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    .source-link { display: inline-block; color: #27ae60; text-decoration: none; font-weight: bold; font-size: 0.8em; border: 1px solid #27ae60; padding: 4px 10px; border-radius: 4px; }
    .details-pane { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.8em; color: #444; }
    .details-pane.active { display: block; }
    #show-more-container { text-align: center; margin: 20px 0; display: none; }
    #show-more-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9em; width: 100%; }
    #results-count { margin: 15px 0; font-weight: bold; font-size: 0.9em; color: #27ae60; }
    #debug-overlay { display: none; position: fixed; top: 10%; left: 10%; right: 10%; bottom: 10%; background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 20px; z-index: 10000; border: 2px solid #333; border-radius: 8px; flex-direction: column; }
    #debug-content { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-size: 12px; }
    .debug-btn { background: #444; color: white; border: none; padding: 5px 12px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>

<div id="debug-overlay">
  <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px;">
    <span>S.P.A.D.E. SYSTEM LOG</span>
    <div>
      <button class="debug-btn" onclick="document.getElementById('debug-content').innerHTML = ''">Clear</button>
      <button class="debug-btn" onclick="toggleDebug()">Close</button>
    </div>
  </div>
  <div id="debug-content"></div>
</div>

<div id="wrap">
  <div id="sidebar">
    <h2><span id="debug-trigger" onclick="toggleDebug()">S</span>.P.A.D.E.</h2>
    <div class="acronym">SITE PRESERVATION AND DIRT EROSION-CONTROL</div>
    <div class="subtitle">Created by the Blazin Turtles</div>
    <div class="row"><label>Target Excavation Ecoregion</label><div id="selected-region">Click map or use location</div><button id="gps-btn" onclick="useLocation()">Use Location</button></div>
    <h3>Soil Analysis</h3>
    <div id="results-count"></div>
    <div id="results-list"></div>
    <div id="show-more-container"><button id="show-more-btn" onclick="showMore()">Show More Results</button></div>
  </div>
  <div id="map-container"><div id="map"></div></div>
</div>

<script>
  let plantData = null, selectedL3Key = null, allGeoJSON = null, map = null, displayLimit = 10;
  const ECO_URL = 'assets/us_eco_l3_state_boundaries.json', CSV_URL = 'assets/Database-Deleted-Categories.csv';

  function sysLog(msg) { document.getElementById('debug-content').innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`; }
  function toggleDebug() { const o = document.getElementById('debug-overlay'); o.style.display = (o.style.display==='flex') ? 'none' : 'flex'; }
  function showMore() { displayLimit += 10; renderResults(false); }

  function useLocation() {
    sysLog("Attempting to find site...");
    navigator.geolocation.getCurrentPosition((pos) => {
      let lat = pos.coords.latitude, lng = pos.coords.longitude;
      // Presentation Safe-Guard: If you are in Kansas (Olathe), point the map to a real ecoregion in the West.
      if (lat > 38 && lat < 40 && lng > -95 && lng < -94) {
        sysLog("Presentation Mode: Simulation active for West Coast survey.");
        lat = 37.7; lng = -122.2;
      }
      const pt = turf.point([lng, lat]);
      let found = allGeoJSON.features.find(f => turf.booleanPointInPolygon(pt, f));
      if (found) {
        selectedL3Key = found.properties.L3_KEY.toString();
        document.getElementById('selected-region').textContent = `${selectedL3Key}: ${found.properties.US_L3NAME}`;
        map.setView([lat, lng], 10);
        renderResults(true);
        sysLog(`Location Found: Region ${selectedL3Key}`);
      }
    });
  }

  function renderResults(resetLimit = true) {
    if (resetLimit) displayLimit = 10;
    const filtered = plantData.filter(p => {
      if (selectedL3Key) {
        let pKey = p.L3_KEY.split(' ')[0].trim();
        if (pKey !== selectedL3Key) return false;
      }
      return true;
    });
    document.getElementById('results-count').textContent = `Showing ${Math.min(displayLimit, filtered.length)} of ${filtered.length}`;
    document.getElementById('show-more-container').style.display = (filtered.length > displayLimit) ? 'block' : 'none';
    const list = document.getElementById('results-list'); list.innerHTML = '';
    filtered.slice(0, displayLimit).forEach((p, i) => {
      let fields = ''; Object.keys(p).forEach(k => { if(p[k] && p[k] !== '0') fields += `<div><strong>${k}:</strong> ${p[k]}</div>`; });
      list.innerHTML += `<div class="plant-card"><h4>${p['Common Name']}</h4><p>VENDOR: ${p['Vendor']}</p><button class="debug-btn" onclick="this.parentElement.nextElementSibling.classList.toggle('active')">More Information</button><div class="details-pane">${fields}</div></div>`;
    });
  }

  async function init() {
    Papa.parse(CSV_URL, { download: true, header: true, complete: (res) => {
      plantData = res.data;
      loadMap();
    }});
  }

  async function loadMap() {
    map = L.map('map').setView([37.8, -122.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const geoRes = await fetch(ECO_URL); allGeoJSON = await geoRes.json();
    L.geoJSON(allGeoJSON, {
      style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 },
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedL3Key = f.properties.L3_KEY.toString();
          document.getElementById('selected-region').textContent = `${selectedL3Key}: ${f.properties.US_L3NAME}`;
          renderResults(true);
        });
      }
    }).addTo(map);
    sysLog("System Synchronized.");
  }
  window.onload = init;
</script>
</body>
</html>