<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. â€“ by Blazing Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #2d3436; }
    #wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    
    #sidebar { padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }

    /* GPS Button Styling */
    #gps-btn { 
      margin-top: 10px; width: 100%; padding: 10px; background: #27ae60; color: white; 
      border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: bold; 
      transition: background 0.2s; 
    }
    #gps-btn:hover { background: #1e8449; }
    
    h2 { margin: 0 0 2px; color: #1a5d1a; font-size: 2.2em; letter-spacing: 2px; }
    .acronym { font-size: 0.85em; color: #27ae60; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; }
    .subtitle { margin-bottom: 20px; color: #636e72; font-weight: bold; font-size: 0.8em; }
    
    h3 { margin: 25px 0 10px; font-size: 1em; border-bottom: 2px solid #27ae60; padding-bottom: 5px; color: #27ae60; text-transform: uppercase; }
    
    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { margin-bottom: 12px; }
    label { font-weight: bold; font-size: 0.8em; display: block; margin-bottom: 4px; color: #4b4b4b; }
    select, input[type="text"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.85em; }
    
    #selected-region { font-weight: bold; color: #2980b9; background: #e1f0fa; padding: 8px; border-radius: 6px; font-size: 0.9em; }
    .plant-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; border-left: 5px solid #27ae60; }
    .plant-card h4 { margin: 0 0 5px; color: #2d3436; font-size: 1.1em; }
    #results-count { margin: 15px 0; font-weight: bold; font-size: 0.9em; color: #27ae60; }
    #status { font-size: 11px; color: #e67e22; margin-top: 10px; font-style: italic; }

    .leaflet-tooltip-custom {
      background: rgba(26, 93, 26, 0.9); color: white; border: none; font-weight: bold; 
      font-size: 12px; border-radius: 4px; padding: 5px 10px;
    }
  </style>
</head>
<body>

<div id="wrap">
  <div id="sidebar">
    <h2>S.P.A.D.E.</h2>
    <div class="acronym">SITE PRESERVATION AND DIRT EROSION-CONTROL</div>
    <div class="subtitle">by blazing turtles</div>
    
    <div class="row">
      <label>Target Excavation Ecoregion</label>
      <div id="selected-region">Click an area on the map</div>
      <button id="gps-btn" onclick="useGPS()">Use GPS Location</button>
    </div>

    <div class="row">
      <label for="search-box">Quick Search</label>
      <input type="text" id="search-box" placeholder="e.g. Oak, Sagebrush..." />
    </div>

    <h3>Stability & Growth</h3>
    <div class="filter-grid">
      <div class="row"><label>Plant Type</label><select id="type-filter"><option value="all">Any Type</option></select></div>
      <div class="row"><label>Root Type</label><select id="root-filter"><option value="all">Any Root</option></select></div>
      <div class="row"><label>Moisture</label><select id="moisture-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Sun</label><select id="sun-filter"><option value="all">Any</option></select></div>
    </div>

    <h3>Soil Analysis</h3>
    <div class="filter-grid">
      <div class="row"><label>Clay</label><select id="clay-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Sand</label><select id="sand-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Gravel</label><select id="gravel-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Loam</label><select id="loam-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Silt</label><select id="silt-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Peat</label><select id="peat-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Chalky</label><select id="chalky-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
    </div>

    <div id="status">System starting...</div>
    <div id="results-count"></div>
    <div id="results-list"></div>
  </div>

  <div id="map-container">
    <div id="map"></div>
  </div>
</div>

<script>
  let plantData = null;
  let selectedL3Key = null;
  let regionCounts = {};
  let map = null;
  let allGeoJSON = null;

  const ECO_URL = 'assets/us_eco_l3_state_boundaries.json'; 
  const CSV_URL = 'assets/Database-Deleted-Categories.csv';

  function populate(id, col, data) {
    const sel = document.getElementById(id);
    const vals = new Set();
    data.forEach(r => { if(r[col] && r[col] !== '0') r[col].split(',').forEach(v => vals.add(v.trim())); });
    Array.from(vals).sort().forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
    });
  }

  function renderResults() {
    if (!plantData) return;
    const query = document.getElementById('search-box').value.toLowerCase();
    const filters = {
      type: document.getElementById('type-filter').value,
      root: document.getElementById('root-filter').value,
      moisture: document.getElementById('moisture-filter').value,
      sun: document.getElementById('sun-filter').value,
      clay: document.getElementById('clay-filter').value,
      sand: document.getElementById('sand-filter').value,
      gravel: document.getElementById('gravel-filter').value,
      loam: document.getElementById('loam-filter').value,
      silt: document.getElementById('silt-filter').value,
      peat: document.getElementById('peat-filter').value,
      chalky: document.getElementById('chalky-filter').value
    };

    const filtered = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (filters.type !== 'all' && !(p['Plant Type'] || '').includes(filters.type)) return false;
      if (filters.root !== 'all' && !(p['ROOT_TYPE'] || '').includes(filters.root)) return false;
      if (filters.moisture !== 'all' && !(p['Soil Moisture'] || '').includes(filters.moisture)) return false;
      if (filters.sun !== 'all' && !(p['SUN_EXPOSURE'] || '').includes(filters.sun)) return false;
      
      if (filters.clay !== 'all' && p['CLAY_SOIL'] !== filters.clay) return false;
      if (filters.sand !== 'all' && p['SAND_SOIL'] !== filters.sand) return false;
      if (filters.gravel !== 'all' && p['GRAVEL_SOIL'] !== filters.gravel) return false;
      if (filters.loam !== 'all' && p['LOAM_SOIL'] !== filters.loam) return false;
      if (filters.silt !== 'all' && p['SILT_SOIL'] !== filters.silt) return false;
      if (filters.peat !== 'all' && p['PEAT_SOIL'] !== filters.peat) return false;
      if (filters.chalky !== 'all' && p['CHALKY_SOIL'] !== filters.chalky) return false;

      if (query && !((p['Common Name'] || '').toLowerCase().includes(query) || (p['Scientific Name'] || '').toLowerCase().includes(query))) return false;
      return true;
    });

    document.getElementById('results-count').textContent = `Found ${filtered.length} matches`;
    const list = document.getElementById('results-list');
    list.innerHTML = '';
    filtered.slice(0, 50).forEach(p => {
      const card = document.createElement('div');
      card.className = 'plant-card';
      card.innerHTML = `<h4>${p['Common Name']}</h4><p><em>${p['Scientific Name']}</em></p><p>ROOTS: ${p['ROOT_TYPE']} (${p['ROOT_DEPTH']})</p>`;
      list.appendChild(card);
    });
  }

  // GPS Functionality
  function useGPS() {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }
    
    document.getElementById('status').textContent = "Detecting site location...";
    
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      
      if (!allGeoJSON) {
        alert("Wait for map data to finish loading.");
        return;
      }

      let foundFeature = null;
      for (const feature of allGeoJSON.features) {
        if (isPointInFeature(lng, lat, feature)) {
          foundFeature = feature;
          break;
        }
      }

      if (foundFeature) {
        const key = foundFeature.properties.L3_KEY;
        const name = foundFeature.properties.US_L3NAME || foundFeature.properties.NA_L3NAME || "Unknown";
        selectedL3Key = key;
        document.getElementById('selected-region').textContent = `${key}: ${name}`;
        document.getElementById('status').textContent = "Ecoregion identified via GPS.";
        map.setView([lat, lng], 9);
        renderResults();
      } else {
        alert("Your GPS location is outside the mapped ecoregions.");
        document.getElementById('status').textContent = "Location outside survey area.";
      }
    }, (err) => {
      alert("GPS Error: " + err.message);
      document.getElementById('status').textContent = "GPS Access Denied.";
    });
  }

  function isPointInFeature(x, y, feature) {
    const type = feature.geometry.type;
    const coords = feature.geometry.coordinates;
    if (type === "Polygon") return pointInPoly(x, y, coords[0]);
    if (type === "MultiPolygon") return coords.some(p => pointInPoly(x, y, p[0]));
    return false;
  }

  function pointInPoly(x, y, vs) {
    let inside = false;
    for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
      const xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
      if (((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) inside = !inside;
    }
    return inside;
  }

  async function init() {
    Papa.parse(CSV_URL, {
      download: true, header: true,
      complete: (res) => {
        plantData = res.data;
        plantData.forEach(p => { if(p.L3_KEY) regionCounts[p.L3_KEY] = (regionCounts[p.L3_KEY] || 0) + 1; });
        populate('type-filter', 'Plant Type', plantData);
        populate('root-filter', 'ROOT_TYPE', plantData);
        populate('moisture-filter', 'Soil Moisture', plantData);
        populate('sun-filter', 'SUN_EXPOSURE', plantData);
        document.getElementById('status').textContent = 'Database Active';
        renderResults();
        loadMap();
      }
    });
  }

  async function loadMap() {
    map = L.map('map').setView([37.8, -122.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const geoRes = await fetch(ECO_URL);
    allGeoJSON = await geoRes.json();
    
    L.geoJSON(allGeoJSON, {
      style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 },
      onEachFeature: (f, l) => {
        const key = f.properties.L3_KEY;
        const name = f.properties.US_L3NAME || "Unknown";
        const count = regionCounts[key] || 0;

        l.bindTooltip(`<strong>Region ${key}:</strong> ${name}<br/>${count} Plants`, { sticky: true, className: 'leaflet-tooltip-custom' });

        l.on({
          mouseover: (e) => e.target.setStyle({ fillOpacity: 0.4 }),
          mouseout: (e) => e.target.setStyle({ fillOpacity: 0.1 }),
          click: (e) => {
            selectedL3Key = key;
            document.getElementById('selected-region').textContent = `${key}: ${name}`;
            renderResults();
          }
        });
      }
    }).addTo(map);
  }

  document.querySelectorAll('select, input').forEach(el => el.addEventListener('change', renderResults));
  window.onload = init;
</script>

</body>
</html>