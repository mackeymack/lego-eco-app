<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blazing Turtles ‚Äì Dig Site Plant Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (robust CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; }
    h2 { margin: 8px 0 6px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; margin: 4px 6px 0 0; }
    .row { margin: 10px 0; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .small { color:#666; font-size: 12px; }
    .plant { border: 1px solid #eee; border-radius: 10px; padding: 8px; margin: 8px 0; }
    .plant b { display:block; margin-bottom: 3px; }
    code { background:#f6f6f6; padding:2px 4px; border-radius:6px; }

    /* --- Debug UI --- */
    #debugFab {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    #debugModalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9998;
      display: none;
    }
    #debugModal {
      position: fixed;
      right: 14px;
      bottom: 62px;
      width: min(560px, calc(100vw - 28px));
      height: min(420px, calc(100vh - 90px));
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      z-index: 9999;
      display: none;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    #debugModalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      background: #f7f7f7;
    }
    #debugModalHeader .btnRow { display: flex; gap: 8px; }
    .debugBtn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    #debugLogArea {
      height: calc(100% - 46px);
      padding: 10px 12px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background: #fff;
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="sidebar">
      <h2>üê¢üî•Skye's S.P.A.D.E.</h2>
      <div class="small">
        Click an ecoregion on the map ‚Üí see matching plants from your CSV.
      </div>

      <div class="row">
        <div><b>Selected Ecoregion</b></div>
        <div id="selectedRegion" class="pill">None</div>
      </div>

      <div class="row">
        <div><b>Plant Type Filter</b></div>
        <select id="plantTypeFilter">
          <option value="">(All Plant Types)</option>
        </select>
      </div>

      <div class="row">
        <div><b>Search (Common or Scientific name)</b></div>
        <input id="searchBox" placeholder="type to filter‚Ä¶" />
      </div>

      <div class="row">
        <div><b>Results</b> <span class="small" id="resultCount"></span></div>
        <div id="results"></div>
      </div>

      <hr/>
      <div class="small" id="status">Loading‚Ä¶</div>
      <div class="small" id="colInfo"></div>
    </div>

    <div id="map"></div>
  </div>

  <!-- Debug floating button + modal -->
  <button id="debugFab" title="Open debug log">Debug</button>
  <div id="debugModalBackdrop"></div>
  <div id="debugModal">
    <div id="debugModalHeader">
      <b>Debug Log</b>
      <div class="btnRow">
        <button class="debugBtn" id="debugCopyBtn">Copy</button>
        <button class="debugBtn" id="debugClearBtn">Clear</button>
        <button class="debugBtn" id="debugCloseBtn">Close</button>
      </div>
    </div>
    <div id="debugLogArea">(No logs yet)</div>
  </div>

<script>
  // ============================================================
  // ‚úÖ Your published file URLs (Netlify friendly)
  // Put these files in: /assets/
  // ============================================================
  const ECOREGIONS_URL = '/assets/us_eco_l3_state_boundaries.json';
  const DATABASE_CSV_URL = '/assets/Database-Deleted-Categories.csv'; // ‚úÖ same naming, just .csv

  // ============================================================
  // Debug logger
  // ============================================================
  const DEBUG_LOG_MAX_LINES = 300;
  let debugLines = [];

  function logDebug(message, data) {
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    let line = `[${ts}] ${message}`;
    if (data !== undefined) {
      try { line += ` | ${typeof data === 'string' ? data : JSON.stringify(data)}`; }
      catch { line += ` | (unstringifiable data)`; }
    }
    debugLines.push(line);
    if (debugLines.length > DEBUG_LOG_MAX_LINES) debugLines = debugLines.slice(-DEBUG_LOG_MAX_LINES);
    const area = document.getElementById('debugLogArea');
    if (area) area.textContent = debugLines.length ? debugLines.join('\n') : '(No logs yet)';
  }

  function openDebug() {
    document.getElementById('debugModalBackdrop').style.display = 'block';
    document.getElementById('debugModal').style.display = 'block';
  }
  function closeDebug() {
    document.getElementById('debugModalBackdrop').style.display = 'none';
    document.getElementById('debugModal').style.display = 'none';
  }

  window.addEventListener('error', (e) => {
    logDebug('‚ùå window.error', { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno });
  });
  window.addEventListener('unhandledrejection', (e) => {
    logDebug('‚ùå unhandledrejection', { reason: String(e.reason) });
  });

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('debugFab').addEventListener('click', openDebug);
    document.getElementById('debugModalBackdrop').addEventListener('click', closeDebug);
    document.getElementById('debugCloseBtn').addEventListener('click', closeDebug);

    document.getElementById('debugClearBtn').addEventListener('click', () => {
      debugLines = [];
      logDebug('üßπ Log cleared');
    });

    document.getElementById('debugCopyBtn').addEventListener('click', async () => {
      const text = debugLines.join('\n');
      try {
        await navigator.clipboard.writeText(text);
        logDebug('‚úÖ Copied log to clipboard');
      } catch (err) {
        logDebug('‚ùå Copy failed (clipboard blocked)', String(err));
        alert('Copy blocked by browser. You can manually select the text and copy it.');
      }
    });

    logDebug('‚úÖ Debug UI ready');
  });

  // ============================================================
  // Map setup
  // ============================================================
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ============================================================
  // App state + UI
  // ============================================================
  let plants = [];
  let plantsByL3Full = new Map();
  let plantsByL3Code = new Map();
  let selectedRegion = null; // { fullKey, code, name }

  // Map layer references (for hover tooltips + click highlight)
  let ecoregionsLayer = null;
  const ecoregionLayersByKey = new Map();


  const elSelected = document.getElementById('selectedRegion');
  const elTypeFilter = document.getElementById('plantTypeFilter');
  const elSearch = document.getElementById('searchBox');
  const elResults = document.getElementById('results');
  const elCount = document.getElementById('resultCount');
  const elStatus = document.getElementById('status');
  const elColInfo = document.getElementById('colInfo');

  function setStatus(msg) {
    elStatus.textContent = msg;
    logDebug('‚ÑπÔ∏è status', msg);
  }

  function normalizeKey(s) { return String(s ?? '').toLowerCase().replace(/[\s_\-]+/g, ''); }
  function normText(s) { return String(s ?? '').toLowerCase().trim(); }

  // Detect columns even if headers changed slightly (spaces/dashes/underscores)
  function findColumn(headers, wanted) {
    const w = normalizeKey(wanted);
    for (const h of headers) if (normalizeKey(h) === w) return h;

    // helpful alternates
    const alts = {
      l3_key: ['l3key','l3','ecoregionkey'],
      plant_type: ['planttype','type','category','categories'],
      scientific_name: ['scientificname','sciname','botanicalname','scientific'],
      common_name: ['commonname','name'],
      root_type: ['roottype'],
      root_depth: ['rootdepth','maturerootdepth','maximumrootdepth','maxrootdepth']
    }[w] || [];

    for (const alt of alts) {
      for (const h of headers) if (normalizeKey(h) === alt) return h;
    }
    return null;
  }

  function rebuildTypeDropdown() {
    elTypeFilter.innerHTML = '<option value="">(All Plant Types)</option>';
    const types = new Set(plants.map(p => p.plantType).filter(Boolean));
    [...types].sort((a,b)=>a.localeCompare(b)).forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      elTypeFilter.appendChild(opt);
    });
  }

  function indexPlantsByL3() {
    plantsByL3Full = new Map();
    plantsByL3Code = new Map();

    const addToMap = (map, key, plant) => {
      if (!key) return;
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(plant);
    };

    for (const p of plants) {
      const full = (p.l3KeyFull ?? '').trim();
      const fullCollapsed = (p.l3KeyCollapsed ?? '').trim();
      const code = (p.l3Code ?? '').trim();

      addToMap(plantsByL3Full, full, p);
      if (fullCollapsed && fullCollapsed !== full) addToMap(plantsByL3Full, fullCollapsed, p);
      addToMap(plantsByL3Code, code, p);
    }

    logDebug('‚úÖ indexed plants', { fullKeys: plantsByL3Full.size, codeKeys: plantsByL3Code.size });
  }

  function renderResults() {
    elResults.innerHTML = '';
    elCount.textContent = '';

    if (!selectedRegion || (!selectedRegion.fullKey && !selectedRegion.code)) {
      elResults.innerHTML = '<div class="small">Click an ecoregion to see plants.</div>';
      return;
    }

    const typeFilter = elTypeFilter.value;
    const q = normText(elSearch.value);

    // Merge plants from both matching strategies:
    // 1) Full L3_KEY string (e.g., "25  High Plains")
    // 2) L3 code only (e.g., "25")
    const fullKey = selectedRegion.fullKey || '';
    const code = selectedRegion.code || '';

    const a = (plantsByL3Full.get(fullKey) || []);
    const b = (plantsByL3Code.get(code) || []);

    const merged = [];
    const seen = new Set();

    for (const p of [...a, ...b]) {
      const id = `${p.scientificName || ''}|${p.commonName || ''}|${p.plantType || ''}|${p.l3KeyFull || ''}|${p.l3Code || ''}`;
      if (seen.has(id)) continue;
      seen.add(id);
      merged.push(p);
    }

    const list = merged.filter(p => {
      if (typeFilter && p.plantType !== typeFilter) return false;
      if (!q) return true;
      return normText(p.commonName).includes(q) || normText(p.scientificName).includes(q);
    });

    const shown = list.slice(0, 80);
    elCount.textContent = `(${list.length} matches${list.length > shown.length ? `, showing first ${shown.length}` : ''})`;

    for (const p of shown) {
      const div = document.createElement('div');
      div.className = 'plant';
      div.innerHTML = `
        <b>${p.commonName || '(no common name)'}</b>
        <div class="small"><i>${p.scientificName || '(no scientific name)'}</i></div>
        <div class="small">
          Plant Type: ${p.plantType || '‚Äî'}<br/>
          Root Type: ${p.rootType || '‚Äî'}<br/>
          Root Depth: ${p.rootDepth || '‚Äî'}
        </div>
      `;
      elResults.appendChild(div);
    }
  }

  // ============================================================

  // ============================================================
  // Hover tooltips + click highlight helpers
  // ============================================================
  function extractLeadingCode(value) {
    const s = String(value ?? '').trim();
    const m = s.match(/^\d+/);
    return m ? m[0] : '';
  }

  function collapseSpaces(s) {
    return String(s ?? '').trim().replace(/\s+/g, ' ');
  }

  function getPlantCountForRegion(props) {
    // Try several keys so counts work even if the CSV uses only the code (e.g. "25")
    // while the GeoJSON uses full keys (e.g. "25  High Plains"), or vice-versa.
    const fullKey = String(props?.L3_KEY ?? '').trim();
    const fullCollapsed = collapseSpaces(fullKey);
    const code = String(props?.US_L3CODE ?? '').trim() || extractLeadingCode(fullKey);

    const c1 = (plantsByL3Full.get(fullKey) || []).length;
    const c2 = (plantsByL3Full.get(fullCollapsed) || []).length;
    const c3 = (plantsByL3Code.get(code) || []).length;

    return Math.max(c1, c2, c3);
  }

  function buildTooltipHtml(p) {
    const fullKey = String(p?.L3_KEY ?? '').trim();
    const l3Code = String(p?.US_L3CODE ?? '').trim() || extractLeadingCode(fullKey);
    const l3Name = p?.US_L3NAME || p?.NA_L3NAME || '';
    const count = getPlantCountForRegion(p);

    const safe = (s) => String(s ?? '').replace(/[&<>"]/g, (ch) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
    })[ch]);

    return `
      <div style="font-size:12px; line-height:1.25;">
        <div><b>${safe(l3Code || fullKey || 'Unknown')}</b>${l3Name ? ` ‚Äî ${safe(l3Name)}` : ''}</div>
        <div style="color:#555;">Plants in CSV: <b>${count.toLocaleString()}</b></div>
      </div>
    `;
  }

  function styleForFeature(feature) {
    // base style (no selection)
    return {
      color: '#555',
      weight: 1,
      opacity: 0.8,
      fillColor: '#4f46e5',
      fillOpacity: 0.15
    };
  }

  function styleForDimmed() {
    return {
      color: '#777',
      weight: 1,
      opacity: 0.25,
      fillColor: '#999',
      fillOpacity: 0.05
    };
  }

  function styleForSelected() {
    return {
      color: '#111',
      weight: 3,
      opacity: 1,
      fillColor: '#f59e0b',
      fillOpacity: 0.45
    };
  }

  function styleForHover(isSelected, isDimmed) {
    if (isSelected) {
      return { weight: 4, opacity: 1, fillOpacity: 0.55 };
    }
    if (isDimmed) {
      return { weight: 2, opacity: 0.6 };
    }
    return { weight: 2, opacity: 1, fillOpacity: 0.3 };
  }

  function applySelectionStyles() {
    if (!ecoregionsLayer) return;

    const isSelectedFeature = (props) => {
      if (!selectedRegion) return false;
      const fullKey = String(props?.L3_KEY ?? '').trim();
      const code = String(props?.US_L3CODE ?? '').trim() || extractLeadingCode(fullKey);
      return (selectedRegion.fullKey && fullKey === selectedRegion.fullKey) ||
             (selectedRegion.code && code === selectedRegion.code);
    };

    ecoregionsLayer.eachLayer((layer) => {
      const p = layer?.feature?.properties || {};

      if (!selectedRegion) {
        layer.setStyle(styleForFeature(layer.feature));
        return;
      }

      if (isSelectedFeature(p)) {
        layer.setStyle(styleForSelected());
        try { layer.bringToFront(); } catch {}
      } else {
        layer.setStyle(styleForDimmed());
      }
    });
  }

  function refreshAllTooltips() {
    // Called after CSV loads (plant counts become available)
    ecoregionLayersByKey.forEach((layer) => {
      const p = layer?.feature?.properties || {};
      if (layer.getTooltip && layer.getTooltip()) {
        layer.getTooltip().setContent(buildTooltipHtml(p));
      }
    });
  }

  // Load CSV
  // ============================================================
  async function loadPlantDatabaseCSV() {
    setStatus('Loading plant database CSV‚Ä¶');
    logDebug('‚û°Ô∏è fetch CSV', DATABASE_CSV_URL);

    const res = await fetch(DATABASE_CSV_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è CSV status', res.status);

    if (!res.ok) throw new Error(`Failed to load CSV: ${res.status}`);

    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

    if (parsed.errors?.length) {
      logDebug('‚ö†Ô∏è CSV parse errors (first 5)', parsed.errors.slice(0, 5));
    }

    const rows = parsed.data || [];
    if (!rows.length) throw new Error('CSV loaded but has 0 rows.');

    const headers = Object.keys(rows[0] || {});
    const cL3   = findColumn(headers, 'L3_KEY');
    const cType = findColumn(headers, 'Plant Type');
    const cSci  = findColumn(headers, 'Scientific Name');
    const cCom  = findColumn(headers, 'Common Name');
    const cRT   = findColumn(headers, 'ROOT_TYPE');
    const cRD   = findColumn(headers, 'ROOT_DEPTH');

    elColInfo.innerHTML = `
      <div class="small">
        CSV columns used:
        <br/>L3_KEY = <code>${cL3 || 'NOT FOUND'}</code>
        <br/>Plant Type = <code>${cType || 'NOT FOUND'}</code>
        <br/>Scientific Name = <code>${cSci || 'NOT FOUND'}</code>
        <br/>Common Name = <code>${cCom || 'NOT FOUND'}</code>
        <br/>ROOT_TYPE = <code>${cRT || 'NOT FOUND'}</code>
        <br/>ROOT_DEPTH = <code>${cRD || 'NOT FOUND'}</code>
      </div>
    `;
    logDebug('üßæ detected CSV columns', { cL3, cType, cSci, cCom, cRT, cRD });

    plants = rows.map(r => {
      const rawL3 = cL3 ? String(r[cL3] ?? '') : '';
      const full = String(rawL3).trim();
      const collapsed = collapseSpaces(full);
      const code = extractLeadingCode(full);

      return {
        l3KeyFull: full,
        l3KeyCollapsed: collapsed,
        l3Code: code,

        plantType: cType ? String(r[cType]).trim() : '',
        scientificName: cSci ? String(r[cSci]).trim() : '',
        commonName: cCom ? String(r[cCom]).trim() : '',
        rootType: cRT ? String(r[cRT]).trim() : '',
        rootDepth: cRD ? String(r[cRD]).trim() : ''
      };
    });

    indexPlantsByL3();
    refreshAllTooltips();
    rebuildTypeDropdown();
    setStatus(`Loaded ${plants.length.toLocaleString()} rows from CSV.`);
  }

  // ============================================================
  // Load map GeoJSON
  // ============================================================
  async function loadEcoregionsGeoJSON() {
    setStatus('Loading ecoregion map‚Ä¶');
    logDebug('‚û°Ô∏è fetch GeoJSON', ECOREGIONS_URL);

    const res = await fetch(ECOREGIONS_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è GeoJSON status', res.status);

    if (!res.ok) throw new Error(`Failed to load map JSON: ${res.status}`);

    const geojson = await res.json();
    logDebug('‚úÖ GeoJSON parsed', { type: geojson.type, features: geojson.features?.length });

    // Build interactive layer with:
    // - hover tooltip (L3 code + name + plant count)
    // - click selection highlight (dim others)
    ecoregionLayersByKey.clear();

    function onEachFeature(feature, layer) {
      const p = feature.properties || {};
      const fullKey = String(p.L3_KEY ?? '').trim();
      const code = String(p.US_L3CODE ?? '').trim() || extractLeadingCode(fullKey);

      // Track layers by fullKey (GeoJSON L3_KEY)
      if (fullKey) ecoregionLayersByKey.set(fullKey, layer);

      // Tooltip (sticky, follows mouse)
      layer.bindTooltip(buildTooltipHtml(p), {
        sticky: true,
        direction: 'auto',
        opacity: 0.95
      });

      const isSelectedNow = () => {
        if (!selectedRegion) return false;
        return (selectedRegion.fullKey && fullKey === selectedRegion.fullKey) ||
               (selectedRegion.code && code === selectedRegion.code);
      };
      const isDimmedNow = () => !!selectedRegion && !isSelectedNow();

      // Hover highlight + always refresh tooltip content so plant counts are up to date
      layer.on('mouseover', () => {
        const tt = layer.getTooltip && layer.getTooltip();
        if (tt && tt.setContent) tt.setContent(buildTooltipHtml(p));
        layer.setStyle(styleForHover(isSelectedNow(), isDimmedNow()));
      });

      layer.on('mouseout', () => {
        if (!selectedRegion) {
          layer.setStyle(styleForFeature(feature));
        } else if (isSelectedNow()) {
          layer.setStyle(styleForSelected());
        } else {
          layer.setStyle(styleForDimmed());
        }
      });

      // Click selection
      layer.on('click', () => {
        selectedRegion = {
          fullKey,
          code,
          name: (p.US_L3NAME || p.NA_L3NAME || null)
        };

        const labelCore = (selectedRegion.code || selectedRegion.fullKey || 'Unknown region');
        elSelected.textContent = selectedRegion.name ? `${labelCore} ‚Äî ${selectedRegion.name}` : labelCore;

        logDebug('üó∫Ô∏è region clicked', selectedRegion);

        applySelectionStyles();
        renderResults();
      });
    }

    // Remove previous layer if reloading
    if (ecoregionsLayer) {
      try { map.removeLayer(ecoregionsLayer); } catch {}
      ecoregionsLayer = null;
    }

    ecoregionsLayer = L.geoJSON(geojson, {
      style: styleForFeature,
      onEachFeature
    }).addTo(map);

    // In case CSV already loaded before map
    refreshAllTooltips();

    setStatus('Map loaded. Hover for details; click to select an ecoregion.');
  }


  // UI events
  elTypeFilter.addEventListener('change', renderResults);
  elSearch.addEventListener('input', renderResults);

  // ============================================================
  // Boot (loads map even if CSV fails)
  // ============================================================
  (async function start() {
    try {
      logDebug('üöÄ App starting', { ECOREGIONS_URL, DATABASE_CSV_URL });

      await loadEcoregionsGeoJSON();

      try {
        await loadPlantDatabaseCSV();
      } catch (e) {
        logDebug('‚ùå CSV failed to load', String(e));
        setStatus('ERROR loading CSV: ' + e.message);
        openDebug();
      }

      renderResults();
      logDebug('‚úÖ App ready');
    } catch (err) {
      logDebug('‚ùå App start error', String(err));
      setStatus('ERROR: ' + err.message);
      openDebug();
    }
  })();
</script>
</body>
</html>
