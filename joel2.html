<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blazing Turtles ‚Äì Dig Site Plant Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; background:#fff; }
    #map { height: 100vh; background:#f4f4f4; position: relative; } /* IMPORTANT so toolbar can sit on the map */
    h2 { margin: 8px 0 6px; }
    .row { margin: 12px 0; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .small { color:#666; font-size: 12px; }
    code { background:#f6f6f6; padding:2px 4px; border-radius:6px; }

    /* ============================================================
       Presentation / Demo Mode + Collapsible Sidebar (iPad-friendly)
       ============================================================ */

    :root{
      --ui-font-base: 14px;
      --ui-font-title: 22px;
      --ui-control-height: 38px;
      --ui-control-font: 14px;
      --ui-gap: 10px;
      --ui-radius: 14px;
      --ui-shadow: 0 10px 28px rgba(0,0,0,0.18);
      --card-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }

    body.demo-mode{
      --ui-font-base: 18px;
      --ui-font-title: 28px;
      --ui-control-height: 54px;
      --ui-control-font: 18px;
      --ui-gap: 14px;
      --ui-radius: 18px;
    }

    body { font-size: var(--ui-font-base); }
    h2 { font-size: var(--ui-font-title); }
    input, select, button { font-size: var(--ui-control-font); }

    input, select{
      height: var(--ui-control-height);
      padding: 10px 12px;
      border-radius: var(--ui-radius);
      border: 1px solid #cfcfcf;
      outline: none;
      background: #fff;
    }
    input:focus, select:focus{
      border-color:#7aa7ff;
      box-shadow: 0 0 0 3px rgba(122,167,255,0.25);
    }

    /* Demo / toolbar floating controls
       NOTE: We will move this element into #map so it never covers the sidebar title.
    */
    #demoToolbar{
      position: absolute;   /* anchored to #map */
      left: 12px;
      top: 12px;
      z-index: 9997;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border-radius: 18px;
      background: rgba(255,255,255,0.92);
      border: 1px solid #e5e5e5;
      box-shadow: var(--ui-shadow);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      user-select: none;
      pointer-events: auto;
    }

    .demoBtn{
      height: var(--ui-control-height);
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }
    .demoBtn.secondary{
      background: #fff;
      color: #111;
      border-color: #cfcfcf;
    }
    .demoBtn:active{ transform: translateY(1px); }

    /* Toggle switch */
    .switch{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      height: var(--ui-control-height);
      border-radius: 999px;
      border: 1px solid #cfcfcf;
      background: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .switchDot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ddd;
      position: relative;
      flex: 0 0 auto;
    }
    .switchDot::after{
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      transform: translateX(0);
      transition: transform 160ms ease;
    }
    body.demo-mode .switchDot{ background: #111; }
    body.demo-mode .switchDot::after{ transform: translateX(10px); }

    /* Desktop panel hidden (IMPORTANT: keep map visible; Leaflet needs invalidateSize()) */
    body.panel-hidden #wrap{ grid-template-columns: 0 1fr; }
    body.panel-hidden #sidebar{
      width: 0;
      padding: 0;
      border-right: 0;
      overflow: hidden;
    }

    /* Mobile / iPad drawer behavior */
    #sidebarBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 9996;
      display: none;
    }

    @media (max-width: 980px){
      #wrap{ grid-template-columns: 1fr; }
      #map{ height: 100vh; }
      #sidebar{
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: min(420px, 86vw);
        z-index: 9999;
        background: #fff;
        border-right: 1px solid #ddd;
        transform: translateX(-110%);
        transition: transform 180ms ease;
        box-shadow: var(--ui-shadow);
        padding: 12px;
      }
      body.sidebar-open #sidebar{ transform: translateX(0); }
      body.sidebar-open #sidebarBackdrop{ display: block; }
      body.panel-hidden #sidebar{ width: min(420px, 86vw); padding: 12px; border-right:1px solid #ddd; }

      /* Keep toolbar snug on smaller screens */
      #demoToolbar{ left: 10px; top: 10px; }
    }

    /* ============================================================
       Competition polish: Demo guide + plant cards
       ============================================================ */

    .demoGuide{
      margin: 10px 0 14px;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 16px;
      background: #fafafa;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }
    .demoGuide .title{
      font-weight: 700;
      margin-bottom: 6px;
    }
    .steps{ display: grid; gap: 8px; }
    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 8px 10px;
      border: 1px solid #eee;
      border-radius: 14px;
      background: #fff;
    }
    .step .num{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      border: 1px solid #ddd;
      background:#f7f7f7;
      flex: 0 0 auto;
    }
    body.demo-mode .step .num{ width: 34px; height: 34px; }
    .step .txt{ line-height: 1.25; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      margin: 6px 6px 0 0;
      background:#fff;
      max-width: 100%;
    }
    .pill b{ font-weight:700; }

    .plantCard{
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 10px 12px;
      margin: 10px 0;
      background: #fff;
      box-shadow: var(--card-shadow);
    }
    body.demo-mode .plantCard{
      border-radius: 20px;
      padding: 14px 14px;
      margin: 14px 0;
    }
    .plantHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .plantName{
      font-weight: 800;
      line-height: 1.15;
      font-size: 1.02em;
    }
    body.demo-mode .plantName{ font-size: 1.12em; }
    .sciName{
      color:#444;
      font-style: italic;
      margin-top: 3px;
      line-height: 1.2;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e5e5;
      background: #fafafa;
      font-size: 0.92em;
    }
    body.demo-mode .chip{ padding: 8px 12px; }
    .chip .ico{ font-size: 1.05em; }

    /* Floating hint for demo mode */
    #floatingHint{
      position: fixed;
      left: 12px;
      bottom: 14px;
      z-index: 9995;
      display: none;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid #e5e5e5;
      background: rgba(255,255,255,0.92);
      box-shadow: var(--ui-shadow);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      max-width: min(520px, calc(100vw - 24px));
    }
    #floatingHint b{ font-weight: 800; }
    body.demo-mode #floatingHint{ display: block; }

    /* ============================================================
       Debug UI (secret reveal via triple-click üê¢)
       - Always logs everything
       - Hidden by default
       - "Hide" hides the button again
       ============================================================ */

    #debugFab, #debugModalBackdrop, #debugModal { display: none; }
    body.debug-visible #debugFab { display: block; }

    #debugFab{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    #debugModalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9998;
    }
    #debugModal{
      position: fixed;
      right: 14px;
      bottom: 62px;
      width: min(620px, calc(100vw - 28px));
      height: min(460px, calc(100vh - 90px));
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      z-index: 9999;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    #debugModalHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      background: #f7f7f7;
    }
    #debugModalHeader .btnRow{ display:flex; gap:8px; }
    .debugBtn{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    #debugLogArea{
      height: calc(100% - 46px);
      padding: 10px 12px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background: #fff;
    }

    /* Make the turtle look tappable */
    #turtleTapTarget{
      cursor: pointer;
      user-select: none;
      padding: 2px 6px;
      border-radius: 10px;
    }
    #turtleTapTarget:hover{
      background: #f3f3f3;
    }
  </style>
</head>

<body>
  <div id="sidebarBackdrop" aria-hidden="true"></div>

  <div id="wrap">
    <div id="sidebar">
      <h2>
        <span id="turtleTapTarget" title="(Secret) Tap 3 times to show Debug">üê¢</span>
        üî• Joel's S.P.A.D.E.
      </h2>

      <div class="small">Click an ecoregion on the map ‚Üí see matching plants from your CSV.</div>

      <div class="demoGuide" aria-label="Demo guide">
        <div class="title">Competition Demo (30 seconds)</div>
        <div class="steps">
          <div class="step"><div class="num">1</div><div class="txt"><b>Tap a region</b> on the map.</div></div>
          <div class="step"><div class="num">2</div><div class="txt"><b>Filter plants</b> by type or search a name.</div></div>
          <div class="step"><div class="num">3</div><div class="txt"><b>Use root info</b> to pick plants that stabilize soil.</div></div>
        </div>
      </div>

      <div class="row">
        <div><b>Selected Ecoregion</b></div>
        <div id="selectedRegion" class="pill"><b>None</b></div>
      </div>

      <div class="row">
        <div><b>Plant Type Filter</b></div>
        <select id="plantTypeFilter">
          <option value="">(All Plant Types)</option>
        </select>
      </div>

      <div class="row">
        <div><b>Search (Common or Scientific name)</b></div>
        <input id="searchBox" placeholder="type to filter‚Ä¶" />
      </div>

      <div class="row">
        <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px;">
          <div><b>Results</b></div>
          <div class="small" id="resultCount"></div>
        </div>
        <div id="results"></div>
      </div>

      <hr/>
      <div class="small" id="status">Loading‚Ä¶</div>
      <div class="small" id="colInfo"></div>
    </div>

    <div id="map">
      <!-- Presentation controls (will live ON the map, not over the sidebar) -->
      <div id="demoToolbar" aria-label="Presentation controls">
        <button class="demoBtn secondary" id="panelToggleBtn" type="button" title="Show/Hide the left panel">‚ò∞ Panel</button>

        <div class="switch" id="demoToggle" role="button" tabindex="0" aria-pressed="false" title="Toggle big, competition-ready UI">
          <span class="switchDot" aria-hidden="true"></span>
          <span><b>Demo Mode</b></span>
        </div>

        <button class="demoBtn secondary" id="resetBtn" type="button" title="Reset selection and filters">‚Ü∫ Reset</button>
      </div>
    </div>
  </div>

  <div id="floatingHint">
    <b>Tip:</b> Tap <b>‚ò∞ Panel</b> to open filters ‚Ä¢ Tap a region to see plants
  </div>

  <!-- Secret Debug UI -->
  <button id="debugFab" title="Open debug log">Debug</button>
  <div id="debugModalBackdrop"></div>
  <div id="debugModal">
    <div id="debugModalHeader">
      <b>Debug Log</b>
      <div class="btnRow">
        <button class="debugBtn" id="debugCopyBtn">Copy</button>
        <button class="debugBtn" id="debugClearBtn">Clear</button>
        <button class="debugBtn" id="debugHideBtn">Hide</button>
        <button class="debugBtn" id="debugCloseBtn">Close</button>
      </div>
    </div>
    <div id="debugLogArea">(No logs yet)</div>
  </div>

<script>
  // Assets
  const ECOREGIONS_URL = '/assets/us_eco_l3_state_boundaries.json';
  const DATABASE_CSV_URL = '/assets/Database-Deleted-Categories.csv';

  // ============================================================
  // Debug logging (ALWAYS ON; UI is secret)
  // ============================================================
  const DEBUG_LOG_MAX_LINES = 1500;
  let debugLines = [];

  function logDebug(message, data) {
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    let line = `[${ts}] ${message}`;
    if (data !== undefined) {
      try { line += ` | ${typeof data === 'string' ? data : JSON.stringify(data)}`; }
      catch { line += ` | (unstringifiable data)`; }
    }
    debugLines.push(line);
    if (debugLines.length > DEBUG_LOG_MAX_LINES) debugLines = debugLines.slice(-DEBUG_LOG_MAX_LINES);

    // If the modal is open, live-update it
    const area = document.getElementById('debugLogArea');
    if (area && document.getElementById('debugModal').style.display === 'block') {
      area.textContent = debugLines.join('\n');
      area.scrollTop = area.scrollHeight;
    }
  }

  function openDebug() {
    document.body.classList.add('debug-visible');
    document.getElementById('debugModalBackdrop').style.display = 'block';
    document.getElementById('debugModal').style.display = 'block';
    const area = document.getElementById('debugLogArea');
    area.textContent = debugLines.length ? debugLines.join('\n') : '(No logs yet)';
    area.scrollTop = area.scrollHeight;
    logDebug('ü™≤ Debug opened');
  }
  function closeDebug() {
    document.getElementById('debugModalBackdrop').style.display = 'none';
    document.getElementById('debugModal').style.display = 'none';
    logDebug('ü™≤ Debug closed (button remains visible)');
  }
  function hideDebugCompletely() {
    document.getElementById('debugModalBackdrop').style.display = 'none';
    document.getElementById('debugModal').style.display = 'none';
    document.body.classList.remove('debug-visible');
    logDebug('ü™≤ Debug hidden (secret mode)');
  }

  // ============================================================
  // Presentation UI helpers
  // ============================================================
  const LS_DEMO_KEY = 'spade_demoMode';
  const LS_PANEL_KEY = 'spade_panelState';

  function isMobileLayout() {
    return window.matchMedia('(max-width: 980px)').matches;
  }

  function safelyInvalidateMap() {
    const m = window.__spadeMap;
    if (!m) return;
    requestAnimationFrame(() => m.invalidateSize());
    setTimeout(() => m.invalidateSize(), 220);
    setTimeout(() => m.invalidateSize(), 520);
  }

  function setDemoMode(on) {
    document.body.classList.toggle('demo-mode', !!on);
    document.getElementById('demoToggle').setAttribute('aria-pressed', on ? 'true' : 'false');
    try { localStorage.setItem(LS_DEMO_KEY, on ? '1' : '0'); } catch {}
    safelyInvalidateMap();
    logDebug('üé§ Demo Mode set', { on });
  }

  function setPanelOpen(open) {
    if (isMobileLayout()) {
      document.body.classList.toggle('sidebar-open', !!open);
      document.body.classList.remove('panel-hidden');
    } else {
      document.body.classList.toggle('panel-hidden', !open);
      document.body.classList.remove('sidebar-open');
    }
    try { localStorage.setItem(LS_PANEL_KEY, open ? 'open' : 'closed'); } catch {}
    safelyInvalidateMap();
    logDebug('üìÅ Panel set', { open, mobile: isMobileLayout() });
  }

  function getPanelOpen() {
    if (isMobileLayout()) return document.body.classList.contains('sidebar-open');
    return !document.body.classList.contains('panel-hidden');
  }

  function togglePanel() {
    setPanelOpen(!getPanelOpen());
  }

  // ============================================================
  // Map setup (Leaflet)
  // ============================================================
  const map = L.map('map', { zoomControl: false }).setView([39.5, -98.35], 4);
  window.__spadeMap = map;

  L.control.zoom({ position: 'topright' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ============================================================
  // App state
  // ============================================================
  let plants = [];
  let plantsByL3 = new Map();
  let selectedL3Key = null;
  let selectedL3Name = null;

  const elSelected = document.getElementById('selectedRegion');
  const elTypeFilter = document.getElementById('plantTypeFilter');
  const elSearch = document.getElementById('searchBox');
  const elResults = document.getElementById('results');
  const elCount = document.getElementById('resultCount');
  const elStatus = document.getElementById('status');
  const elColInfo = document.getElementById('colInfo');

  function setStatus(msg) { elStatus.textContent = msg; logDebug('‚ÑπÔ∏è Status', msg); }
  function normalizeKey(s) { return String(s ?? '').toLowerCase().replace(/[\s_\-]+/g, ''); }
  function normText(s) { return String(s ?? '').toLowerCase().trim(); }

  function findColumn(headers, wanted) {
    const w = normalizeKey(wanted);
    for (const h of headers) if (normalizeKey(h) === w) return h;
    const alts = {
      l3_key: ['l3key','l3','ecoregionkey'],
      plant_type: ['planttype','type','category','categories'],
      scientific_name: ['scientificname','sciname','botanicalname','scientific'],
      common_name: ['commonname','name'],
      root_type: ['roottype'],
      root_depth: ['rootdepth','maturerootdepth','maximumrootdepth','maxrootdepth']
    }[w] || [];
    for (const alt of alts) for (const h of headers) if (normalizeKey(h) === alt) return h;
    return null;
  }

  function rebuildTypeDropdown() {
    elTypeFilter.innerHTML = '<option value="">(All Plant Types)</option>';
    const types = new Set(plants.map(p => p.plantType).filter(Boolean));
    [...types].sort((a,b)=>a.localeCompare(b)).forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      elTypeFilter.appendChild(opt);
    });
    logDebug('üßæ Type dropdown rebuilt', { typeCount: types.size });
  }

  function indexPlantsByL3() {
    plantsByL3 = new Map();
    for (const p of plants) {
      if (!p.l3Key) continue;
      if (!plantsByL3.has(p.l3Key)) plantsByL3.set(p.l3Key, []);
      plantsByL3.get(p.l3Key).push(p);
    }
    logDebug('üìö Plants indexed by L3', { keys: plantsByL3.size });
  }

  function fmt(v, fallback='‚Äî') {
    const s = String(v ?? '').trim();
    return s ? s : fallback;
  }

  function renderResults() {
    elResults.innerHTML = '';
    elCount.textContent = '';

    if (!selectedL3Key) {
      elResults.innerHTML = '<div class="small">Click an ecoregion to see plants.</div>';
      logDebug('üß™ Results render', { selected: null });
      return;
    }

    const typeFilter = elTypeFilter.value;
    const q = normText(elSearch.value);

    const list = (plantsByL3.get(selectedL3Key) || []).filter(p => {
      if (typeFilter && p.plantType !== typeFilter) return false;
      if (!q) return true;
      return normText(p.commonName).includes(q) || normText(p.scientificName).includes(q);
    });

    const shown = list.slice(0, 80);
    elCount.textContent = `${list.length} matches${list.length > shown.length ? ` ‚Ä¢ showing first ${shown.length}` : ''}`;

    for (const p of shown) {
      const div = document.createElement('div');
      div.className = 'plantCard';

      const common = fmt(p.commonName, '(no common name)');
      const sci = fmt(p.scientificName, '(no scientific name)');
      const pt = fmt(p.plantType);
      const rt = fmt(p.rootType);
      const rd = fmt(p.rootDepth);

      div.innerHTML = `
        <div class="plantHeader">
          <div>
            <div class="plantName">üåø ${common}</div>
            <div class="sciName">üî¨ ${sci}</div>
          </div>
        </div>
        <div class="chips">
          <div class="chip"><span class="ico">üè∑Ô∏è</span> <span><b>Type</b>: ${pt}</span></div>
          <div class="chip"><span class="ico">üß¨</span> <span><b>Root</b>: ${rt}</span></div>
          <div class="chip"><span class="ico">‚õèÔ∏è</span> <span><b>Depth</b>: ${rd}</span></div>
        </div>
      `;
      elResults.appendChild(div);
    }

    logDebug('üß™ Results render', {
      l3: selectedL3Key,
      typeFilter: typeFilter || '(all)',
      query: q || '(none)',
      totalMatches: list.length,
      shown: shown.length
    });
  }

  function resetAppForDemo() {
    selectedL3Key = null;
    selectedL3Name = null;

    elSelected.innerHTML = '<b>None</b>';
    elTypeFilter.value = '';
    elSearch.value = '';
    renderResults();

    if (isMobileLayout()) setPanelOpen(false);
    logDebug('‚Ü∫ Reset pressed');
  }

  // ============================================================
  // Secret turtle triple-click reveal (works even if Debug is hidden)
  // ============================================================
  (function initTurtleSecret() {
    const turtle = document.getElementById('turtleTapTarget');
    let clicks = 0;
    let timer = null;
    const WINDOW_MS = 900;

    function registerTap() {
      clicks += 1;
      if (timer) clearTimeout(timer);

      timer = setTimeout(() => { clicks = 0; }, WINDOW_MS);

      logDebug('üê¢ Turtle tap', { count: clicks });

      if (clicks >= 3) {
        clicks = 0;
        clearTimeout(timer);
        document.body.classList.add('debug-visible');
        logDebug('ü™≤ Debug revealed via turtle x3');
      }
    }

    turtle.addEventListener('click', registerTap);
    turtle.addEventListener('touchend', (e) => { e.preventDefault(); registerTap(); }, { passive: false });
  })();

  // ============================================================
  // Init UI events
  // ============================================================
  window.addEventListener('DOMContentLoaded', () => {
    const demoToggle = document.getElementById('demoToggle');
    const panelToggleBtn = document.getElementById('panelToggleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');

    // Restore demo mode
    let demoOn = false;
    try { demoOn = localStorage.getItem(LS_DEMO_KEY) === '1'; } catch {}
    setDemoMode(demoOn);

    // Restore panel state
    if (isMobileLayout()) {
      setPanelOpen(false);
    } else {
      let panelOpen = true;
      try { panelOpen = (localStorage.getItem(LS_PANEL_KEY) || 'open') === 'open'; } catch {}
      setPanelOpen(panelOpen);
    }

    panelToggleBtn.addEventListener('click', () => { logDebug('üñ±Ô∏è Panel button clicked'); togglePanel(); });
    sidebarBackdrop.addEventListener('click', () => { logDebug('üñ±Ô∏è Sidebar backdrop clicked (close)'); setPanelOpen(false); });

    demoToggle.addEventListener('click', () => {
      const on = !document.body.classList.contains('demo-mode');
      logDebug('üñ±Ô∏è Demo toggle clicked', { next: on });
      setDemoMode(on);
    });
    demoToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); demoToggle.click(); }
    });

    resetBtn.addEventListener('click', () => { logDebug('üñ±Ô∏è Reset clicked'); resetAppForDemo(); });

    // Close sidebar drawer when tapping map on mobile
    document.getElementById('map').addEventListener('click', () => {
      logDebug('üó∫Ô∏è Map clicked');
      if (isMobileLayout() && document.body.classList.contains('sidebar-open')) setPanelOpen(false);
    });

    // Debug UI buttons (work only if revealed)
    document.getElementById('debugFab').addEventListener('click', openDebug);
    document.getElementById('debugModalBackdrop').addEventListener('click', closeDebug);
    document.getElementById('debugCloseBtn').addEventListener('click', closeDebug);
    document.getElementById('debugHideBtn').addEventListener('click', hideDebugCompletely);

    document.getElementById('debugClearBtn').addEventListener('click', () => {
      debugLines = [];
      document.getElementById('debugLogArea').textContent = '(No logs yet)';
      logDebug('üßπ Log cleared');
    });

    document.getElementById('debugCopyBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(debugLines.join('\n'));
        logDebug('üìã Debug copied to clipboard');
      } catch {
        alert('Copy blocked by browser.');
        logDebug('‚ùå Copy failed');
      }
    });

    // Log input interactions (every change)
    elTypeFilter.addEventListener('change', () => {
      logDebug('üéöÔ∏è Type filter changed', { value: elTypeFilter.value || '(all)' });
      renderResults();
    });

    elSearch.addEventListener('input', () => {
      logDebug('‚å®Ô∏è Search input', { value: elSearch.value });
      renderResults();
    });

    safelyInvalidateMap();
    logDebug('‚úÖ DOM ready');
  });

  // ============================================================
  // Load GeoJSON
  // ============================================================
  async function loadEcoregionsGeoJSON() {
    setStatus('Loading ecoregion map‚Ä¶');
    logDebug('‚û°Ô∏è Fetch GeoJSON', ECOREGIONS_URL);

    const res = await fetch(ECOREGIONS_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è GeoJSON status', res.status);
    if (!res.ok) throw new Error(`Failed to load map JSON: ${res.status}`);

    const geojson = await res.json();
    logDebug('‚úÖ GeoJSON loaded', { features: geojson.features?.length || 0 });

    function onEachFeature(feature, layer) {
      layer.on('click', () => {
        const p = feature.properties || {};
        selectedL3Key = p.L3_KEY || null;
        selectedL3Name = p.US_L3NAME || p.NA_L3NAME || null;

        elSelected.innerHTML = selectedL3Key
          ? `<b>${selectedL3Key}</b>${selectedL3Name ? `&nbsp;‚Äî&nbsp;${selectedL3Name}` : ''}`
          : '<b>Unknown region</b>';

        logDebug('üó∫Ô∏è Region clicked', { selectedL3Key, selectedL3Name });
        renderResults();

        // Demo behavior: on iPad/mobile, auto-open panel after selecting a region
        if (isMobileLayout() && document.body.classList.contains('demo-mode')) {
          logDebug('üìå Auto-open panel after region click (demo mode)');
          setPanelOpen(true);
        }
      });
    }

    L.geoJSON(geojson, { onEachFeature }).addTo(map);
    setStatus('Map loaded. Click an ecoregion!');
    safelyInvalidateMap();
  }

  // ============================================================
  // Load CSV
  // ============================================================
  async function loadPlantDatabaseCSV() {
    setStatus('Loading plant database CSV‚Ä¶');
    logDebug('‚û°Ô∏è Fetch CSV', DATABASE_CSV_URL);

    const res = await fetch(DATABASE_CSV_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è CSV status', res.status);
    if (!res.ok) throw new Error(`Failed to load CSV: ${res.status}`);

    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

    if (parsed.errors?.length) logDebug('‚ö†Ô∏è CSV parse errors (first 5)', parsed.errors.slice(0, 5));

    const rows = parsed.data || [];
    if (!rows.length) throw new Error('CSV loaded but has 0 rows.');

    const headers = Object.keys(rows[0] || {});
    const cL3   = findColumn(headers, 'L3_KEY');
    const cType = findColumn(headers, 'Plant Type');
    const cSci  = findColumn(headers, 'Scientific Name');
    const cCom  = findColumn(headers, 'Common Name');
    const cRT   = findColumn(headers, 'ROOT_TYPE');
    const cRD   = findColumn(headers, 'ROOT_DEPTH');

    elColInfo.innerHTML = `
      <div class="small">
        CSV columns used:
        <br/>L3_KEY = <code>${cL3 || 'NOT FOUND'}</code>
        <br/>Plant Type = <code>${cType || 'NOT FOUND'}</code>
        <br/>Scientific Name = <code>${cSci || 'NOT FOUND'}</code>
        <br/>Common Name = <code>${cCom || 'NOT FOUND'}</code>
        <br/>ROOT_TYPE = <code>${cRT || 'NOT FOUND'}</code>
        <br/>ROOT_DEPTH = <code>${cRD || 'NOT FOUND'}</code>
      </div>
    `;
    logDebug('üßæ Detected CSV columns', { cL3, cType, cSci, cCom, cRT, cRD, rows: rows.length });

    plants = rows.map(r => ({
      l3Key: cL3 ? String(r[cL3]).trim() : '',
      plantType: cType ? String(r[cType]).trim() : '',
      scientificName: cSci ? String(r[cSci]).trim() : '',
      commonName: cCom ? String(r[cCom]).trim() : '',
      rootType: cRT ? String(r[cRT]).trim() : '',
      rootDepth: cRD ? String(r[cRD]).trim() : ''
    }));

    indexPlantsByL3();
    rebuildTypeDropdown();
    setStatus(`Loaded ${plants.length.toLocaleString()} rows from CSV.`);
    logDebug('‚úÖ CSV loaded & indexed');
  }

  // ============================================================
  // Boot
  // ============================================================
  (async function start() {
    try {
      logDebug('üöÄ App starting', { ECOREGIONS_URL, DATABASE_CSV_URL });

      await loadEcoregionsGeoJSON();
      await loadPlantDatabaseCSV();

      renderResults();
      safelyInvalidateMap();

      logDebug('‚úÖ App ready');
    } catch (err) {
      setStatus('ERROR: ' + err.message);
      logDebug('‚ùå App error', String(err));
      // If something breaks, reveal Debug so you can see logs without the secret.
      document.body.classList.add('debug-visible');
      openDebug();
    }
  })();
</script>
</body>
</html>
