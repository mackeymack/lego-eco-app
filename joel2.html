<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blazing Turtles ‚Äì Dig Site Plant Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (robust CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; }
    h2 { margin: 8px 0 6px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; margin: 4px 6px 0 0; }
    .row { margin: 10px 0; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .small { color:#666; font-size: 12px; }
    .plant { border: 1px solid #eee; border-radius: 10px; padding: 8px; margin: 8px 0; }
    .plant b { display:block; margin-bottom: 3px; }
    code { background:#f6f6f6; padding:2px 4px; border-radius:6px; }

    /* --- Debug UI --- */
    #debugFab {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    #debugModalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9998;
      display: none;
    }
    #debugModal {
      position: fixed;
      right: 14px;
      bottom: 62px;
      width: min(560px, calc(100vw - 28px));
      height: min(420px, calc(100vh - 90px));
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      z-index: 9999;
      display: none;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    #debugModalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      background: #f7f7f7;
    }
    #debugModalHeader .btnRow { display: flex; gap: 8px; }
    .debugBtn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    #debugLogArea {
      height: calc(100% - 46px);
      padding: 10px 12px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background: #fff;
    }

    /* ============================================================
       Presentation / Demo Mode + Collapsible Sidebar (iPad-friendly)
       (All changes live ONLY in this personal .html file)
       ============================================================ */

    :root{
      --ui-font-base: 14px;
      --ui-font-title: 22px;
      --ui-control-height: 38px;
      --ui-control-font: 14px;
      --ui-gap: 10px;
      --ui-radius: 14px;
      --ui-shadow: 0 10px 28px rgba(0,0,0,0.18);
    }

    body.demo-mode{
      --ui-font-base: 18px;
      --ui-font-title: 28px;
      --ui-control-height: 54px;
      --ui-control-font: 18px;
      --ui-gap: 14px;
      --ui-radius: 18px;
    }

    /* Apply scalable typography */
    body { font-size: var(--ui-font-base); }
    h2 { font-size: var(--ui-font-title); }
    input, select, button { font-size: var(--ui-control-font); }

    /* Bigger, touch-friendly controls */
    input, select{
      height: var(--ui-control-height);
      padding: 10px 12px;
      border-radius: var(--ui-radius);
      border: 1px solid #cfcfcf;
      outline: none;
    }
    input:focus, select:focus{
      border-color:#7aa7ff;
      box-shadow: 0 0 0 3px rgba(122,167,255,0.25);
    }

    /* Make plant cards more readable in demo mode */
    body.demo-mode .plant{
      padding: 12px;
      border-radius: 18px;
      margin: 12px 0;
      border: 1px solid #e8e8e8;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    body.demo-mode .small{
      font-size: 14px;
      line-height: 1.35;
    }

    /* Demo / toolbar floating controls */
    #demoToolbar{
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 9997; /* below debug modal, above map */
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border-radius: 18px;
      background: rgba(255,255,255,0.92);
      border: 1px solid #e5e5e5;
      box-shadow: var(--ui-shadow);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      user-select: none;
    }

    .demoBtn{
      height: var(--ui-control-height);
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }
    .demoBtn.secondary{
      background: #fff;
      color: #111;
      border-color: #cfcfcf;
    }
    .demoBtn:active{ transform: translateY(1px); }

    /* Toggle switch */
    .switch{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      height: var(--ui-control-height);
      border-radius: 999px;
      border: 1px solid #cfcfcf;
      background: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .switchDot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ddd;
      position: relative;
      flex: 0 0 auto;
    }
    .switchDot::after{
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      transform: translateX(0);
      transition: transform 160ms ease;
    }
    body.demo-mode .switchDot{ background: #111; }
    body.demo-mode .switchDot::after{ transform: translateX(10px); }

    /* Wrap layout: desktop vs mobile */
    #wrap{
      display: grid;
      grid-template-columns: 380px 1fr;
      height: 100vh;
    }

    /* Panel hidden (desktop) */
    body.panel-hidden #wrap{ grid-template-columns: 0 1fr; }
    body.panel-hidden #sidebar{ display: none; }

    /* Mobile / iPad drawer behavior */
    #sidebarBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 9996;
      display: none;
    }

    @media (max-width: 980px){
      #wrap{ grid-template-columns: 1fr; }
      #map{ height: 100vh; }
      #sidebar{
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: min(420px, 86vw);
        z-index: 9999;
        background: #fff;
        border-right: 1px solid #ddd;
        transform: translateX(-110%);
        transition: transform 180ms ease;
        box-shadow: var(--ui-shadow);
      }
      body.sidebar-open #sidebar{
        transform: translateX(0);
      }
      body.sidebar-open #sidebarBackdrop{
        display: block;
      }
    }

    /* Keep debug FAB from hiding under toolbar on small screens */
    @media (max-width: 980px){
      #debugFab{ bottom: 14px; right: 14px; }
      #demoToolbar{ left: 10px; top: 10px; }
    }
  </style>
</head>

<body>

  <!-- Presentation / Demo Mode toolbar -->
  <div id="demoToolbar" aria-label="Presentation controls">
    <button class="demoBtn secondary" id="panelToggleBtn" type="button" title="Show/Hide the left panel">‚ò∞ Panel</button>

    <div class="switch" id="demoToggle" role="button" tabindex="0" aria-pressed="false" title="Toggle big, competition-ready UI">
      <span class="switchDot" aria-hidden="true"></span>
      <span><b>Demo Mode</b></span>
    </div>

    <button class="demoBtn secondary" id="resetBtn" type="button" title="Reset selection and filters">‚Ü∫ Reset</button>
  </div>

  <!-- Backdrop for sidebar drawer on mobile/iPad -->
  <div id="sidebarBackdrop" aria-hidden="true"></div>

  <div id="wrap">
    <div id="sidebar">
      <h2>üê¢üî• Joel's S.P.A.D.E.</h2>
      <div class="small">
        Click an ecoregion on the map ‚Üí see matching plants from your CSV.
      </div>

      <div class="row">
        <div><b>Selected Ecoregion</b></div>
        <div id="selectedRegion" class="pill">None</div>
      </div>

      <div class="row">
        <div><b>Plant Type Filter</b></div>
        <select id="plantTypeFilter">
          <option value="">(All Plant Types)</option>
        </select>
      </div>

      <div class="row">
        <div><b>Search (Common or Scientific name)</b></div>
        <input id="searchBox" placeholder="type to filter‚Ä¶" />
      </div>

      <div class="row">
        <div><b>Results</b> <span class="small" id="resultCount"></span></div>
        <div id="results"></div>
      </div>

      <hr/>
      <div class="small" id="status">Loading‚Ä¶</div>
      <div class="small" id="colInfo"></div>
    </div>

    <div id="map"></div>
  </div>

  <!-- Debug floating button + modal -->
  <button id="debugFab" title="Open debug log">Debug</button>
  <div id="debugModalBackdrop"></div>
  <div id="debugModal">
    <div id="debugModalHeader">
      <b>Debug Log</b>
      <div class="btnRow">
        <button class="debugBtn" id="debugCopyBtn">Copy</button>
        <button class="debugBtn" id="debugClearBtn">Clear</button>
        <button class="debugBtn" id="debugCloseBtn">Close</button>
      </div>
    </div>
    <div id="debugLogArea">(No logs yet)</div>
  </div>

<script>
  // ============================================================
  // ‚úÖ Your published file URLs (Netlify friendly)
  // Put these files in: /assets/
  // ============================================================
  const ECOREGIONS_URL = '/assets/us_eco_l3_state_boundaries.json';
  const DATABASE_CSV_URL = '/assets/Database-Deleted-Categories.csv'; // ‚úÖ same naming, just .csv

  // ============================================================
  // Debug logger
  // ============================================================
  const DEBUG_LOG_MAX_LINES = 300;
  let debugLines = [];

  function logDebug(message, data) {
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    let line = `[${ts}] ${message}`;
    if (data !== undefined) {
      try { line += ` | ${typeof data === 'string' ? data : JSON.stringify(data)}`; }
      catch { line += ` | (unstringifiable data)`; }
    }
    debugLines.push(line);
    if (debugLines.length > DEBUG_LOG_MAX_LINES) debugLines = debugLines.slice(-DEBUG_LOG_MAX_LINES);
    const area = document.getElementById('debugLogArea');
    if (area) area.textContent = debugLines.length ? debugLines.join('\n') : '(No logs yet)';
  }

  function openDebug() {
    document.getElementById('debugModalBackdrop').style.display = 'block';
    document.getElementById('debugModal').style.display = 'block';
  }
  function closeDebug() {
    document.getElementById('debugModalBackdrop').style.display = 'none';
    document.getElementById('debugModal').style.display = 'none';
  }

  window.addEventListener('error', (e) => {
    logDebug('‚ùå window.error', { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno });
  });
  window.addEventListener('unhandledrejection', (e) => {
    logDebug('‚ùå unhandledrejection', { reason: String(e.reason) });
  });

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('debugFab').addEventListener('click', openDebug);
    document.getElementById('debugModalBackdrop').addEventListener('click', closeDebug);
    document.getElementById('debugCloseBtn').addEventListener('click', closeDebug);

    document.getElementById('debugClearBtn').addEventListener('click', () => {
      debugLines = [];
      logDebug('üßπ Log cleared');
    });

    document.getElementById('debugCopyBtn').addEventListener('click', async () => {
      const text = debugLines.join('\n');
      try {
        await navigator.clipboard.writeText(text);
        logDebug('‚úÖ Copied log to clipboard');
      } catch (err) {
        logDebug('‚ùå Copy failed (clipboard blocked)', String(err));
        alert('Copy blocked by browser. You can manually select the text and copy it.');
      }
    });

    // ============================================================
    // Presentation / Demo Mode UI
    // ============================================================
    const LS_DEMO_KEY = 'spade_demoMode';
    const LS_PANEL_KEY = 'spade_panelState'; // 'open' | 'closed' (desktop)
    const demoToggle = document.getElementById('demoToggle');
    const panelToggleBtn = document.getElementById('panelToggleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');

    function isMobileLayout() {
      return window.matchMedia('(max-width: 980px)').matches;
    }

    function setDemoMode(on) {
      document.body.classList.toggle('demo-mode', !!on);
      demoToggle.setAttribute('aria-pressed', on ? 'true' : 'false');
      try { localStorage.setItem(LS_DEMO_KEY, on ? '1' : '0'); } catch {}
    }

    function setPanelOpen(open) {
      if (isMobileLayout()) {
        document.body.classList.toggle('sidebar-open', !!open);
      } else {
        // On desktop, we collapse the grid sidebar entirely
        document.body.classList.toggle('panel-hidden', !open);
      }
    }

    function getPanelOpen() {
      if (isMobileLayout()) {
        return document.body.classList.contains('sidebar-open');
      }
      return !document.body.classList.contains('panel-hidden');
    }

    function togglePanel() {
      setPanelOpen(!getPanelOpen());
      // Remember preference for desktop only; on mobile we default closed on load
      try { localStorage.setItem(LS_PANEL_KEY, getPanelOpen() ? 'open' : 'closed'); } catch {}
      updatePanelButtonLabel();
    }

    function updatePanelButtonLabel() {
      // Keep label stable; the motion is the cue. Title explains.
      panelToggleBtn.textContent = '‚ò∞ Panel';
    }

    function resetAppForDemo() {
      // Clear selection + filters (keep data loaded)
      selectedL3Key = null;
      selectedL3Name = null;

      elSelected.textContent = 'None';
      elTypeFilter.value = '';
      elSearch.value = '';

      renderResults();
      logDebug('‚Ü∫ Reset pressed', { selectedL3Key, selectedL3Name });

      // On mobile, close the drawer so visitors see the map again
      if (isMobileLayout()) setPanelOpen(false);
    }

    function toggleDemoMode() {
      const on = !document.body.classList.contains('demo-mode');
      setDemoMode(on);
      logDebug('üé§ Demo Mode toggled', { on });
    }

    function initPresentationUI() {
      // Restore demo mode
      let demoOn = false;
      try { demoOn = localStorage.getItem(LS_DEMO_KEY) === '1'; } catch {}
      setDemoMode(demoOn);

      // Restore desktop panel state (mobile starts closed by default)
      if (isMobileLayout()) {
        setPanelOpen(false);
      } else {
        let panelOpen = true;
        try { panelOpen = (localStorage.getItem(LS_PANEL_KEY) || 'open') === 'open'; } catch {}
        setPanelOpen(panelOpen);
      }
      updatePanelButtonLabel();

      panelToggleBtn.addEventListener('click', togglePanel);
      sidebarBackdrop.addEventListener('click', () => setPanelOpen(false));

      demoToggle.addEventListener('click', toggleDemoMode);
      demoToggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDemoMode(); }
      });

      resetBtn.addEventListener('click', resetAppForDemo);

      // Close sidebar drawer when tapping map on mobile/iPad
      const mapEl = document.getElementById('map');
      mapEl.addEventListener('click', () => {
        if (isMobileLayout() && document.body.classList.contains('sidebar-open')) {
          setPanelOpen(false);
        }
      });

      // Re-evaluate panel state when screen resizes across the breakpoint
      window.addEventListener('resize', () => {
        // If we switch layouts, keep things sane:
        if (isMobileLayout()) {
          // moving to mobile: close drawer
          document.body.classList.remove('panel-hidden');
          setPanelOpen(false);
        } else {
          // moving to desktop: open panel unless previously saved closed
          document.body.classList.remove('sidebar-open');
          let panelOpen = true;
          try { panelOpen = (localStorage.getItem(LS_PANEL_KEY) || 'open') === 'open'; } catch {}
          setPanelOpen(panelOpen);
        }
        updatePanelButtonLabel();
      }, { passive: true });

      logDebug('‚úÖ Presentation UI ready', { demoOn, mobile: isMobileLayout() });
    }

    initPresentationUI();

    logDebug('‚úÖ Debug UI ready');
  });

  // ============================================================
  // Map setup
  // ============================================================
  const map = L.map('map', { zoomControl: false }).setView([39.5, -98.35], 4);
  L.control.zoom({ position: 'topright' }).addTo(map);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ============================================================
  // App state + UI
  // ============================================================
  let plants = [];
  let plantsByL3 = new Map();
  let selectedL3Key = null;
  let selectedL3Name = null;

  const elSelected = document.getElementById('selectedRegion');
  const elTypeFilter = document.getElementById('plantTypeFilter');
  const elSearch = document.getElementById('searchBox');
  const elResults = document.getElementById('results');
  const elCount = document.getElementById('resultCount');
  const elStatus = document.getElementById('status');
  const elColInfo = document.getElementById('colInfo');

  function setStatus(msg) {
    elStatus.textContent = msg;
    logDebug('‚ÑπÔ∏è status', msg);
  }

  function normalizeKey(s) { return String(s ?? '').toLowerCase().replace(/[\s_\-]+/g, ''); }
  function normText(s) { return String(s ?? '').toLowerCase().trim(); }

  // Detect columns even if headers changed slightly (spaces/dashes/underscores)
  function findColumn(headers, wanted) {
    const w = normalizeKey(wanted);
    for (const h of headers) if (normalizeKey(h) === w) return h;

    // helpful alternates
    const alts = {
      l3_key: ['l3key','l3','ecoregionkey'],
      plant_type: ['planttype','type','category','categories'],
      scientific_name: ['scientificname','sciname','botanicalname','scientific'],
      common_name: ['commonname','name'],
      root_type: ['roottype'],
      root_depth: ['rootdepth','maturerootdepth','maximumrootdepth','maxrootdepth']
    }[w] || [];

    for (const alt of alts) {
      for (const h of headers) if (normalizeKey(h) === alt) return h;
    }
    return null;
  }

  function rebuildTypeDropdown() {
    elTypeFilter.innerHTML = '<option value="">(All Plant Types)</option>';
    const types = new Set(plants.map(p => p.plantType).filter(Boolean));
    [...types].sort((a,b)=>a.localeCompare(b)).forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      elTypeFilter.appendChild(opt);
    });
  }

  function indexPlantsByL3() {
    plantsByL3 = new Map();
    for (const p of plants) {
      if (!p.l3Key) continue;
      if (!plantsByL3.has(p.l3Key)) plantsByL3.set(p.l3Key, []);
      plantsByL3.get(p.l3Key).push(p);
    }
    logDebug('‚úÖ indexed plantsByL3', { keys: plantsByL3.size });
  }

  function renderResults() {
    elResults.innerHTML = '';
    elCount.textContent = '';

    if (!selectedL3Key) {
      elResults.innerHTML = '<div class="small">Click an ecoregion to see plants.</div>';
      return;
    }

    const typeFilter = elTypeFilter.value;
    const q = normText(elSearch.value);

    const list = (plantsByL3.get(selectedL3Key) || []).filter(p => {
      if (typeFilter && p.plantType !== typeFilter) return false;
      if (!q) return true;
      return normText(p.commonName).includes(q) || normText(p.scientificName).includes(q);
    });

    const shown = list.slice(0, 80);
    elCount.textContent = `(${list.length} matches${list.length > shown.length ? `, showing first ${shown.length}` : ''})`;

    for (const p of shown) {
      const div = document.createElement('div');
      div.className = 'plant';
      div.innerHTML = `
        <b>${p.commonName || '(no common name)'}</b>
        <div class="small"><i>${p.scientificName || '(no scientific name)'}</i></div>
        <div class="small">
          Plant Type: ${p.plantType || '‚Äî'}<br/>
          Root Type: ${p.rootType || '‚Äî'}<br/>
          Root Depth: ${p.rootDepth || '‚Äî'}
        </div>
      `;
      elResults.appendChild(div);
    }
  }

  // ============================================================
  // Load CSV
  // ============================================================
  async function loadPlantDatabaseCSV() {
    setStatus('Loading plant database CSV‚Ä¶');
    logDebug('‚û°Ô∏è fetch CSV', DATABASE_CSV_URL);

    const res = await fetch(DATABASE_CSV_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è CSV status', res.status);

    if (!res.ok) throw new Error(`Failed to load CSV: ${res.status}`);

    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

    if (parsed.errors?.length) {
      logDebug('‚ö†Ô∏è CSV parse errors (first 5)', parsed.errors.slice(0, 5));
    }

    const rows = parsed.data || [];
    if (!rows.length) throw new Error('CSV loaded but has 0 rows.');

    const headers = Object.keys(rows[0] || {});
    const cL3   = findColumn(headers, 'L3_KEY');
    const cType = findColumn(headers, 'Plant Type');
    const cSci  = findColumn(headers, 'Scientific Name');
    const cCom  = findColumn(headers, 'Common Name');
    const cRT   = findColumn(headers, 'ROOT_TYPE');
    const cRD   = findColumn(headers, 'ROOT_DEPTH');

    elColInfo.innerHTML = `
      <div class="small">
        CSV columns used:
        <br/>L3_KEY = <code>${cL3 || 'NOT FOUND'}</code>
        <br/>Plant Type = <code>${cType || 'NOT FOUND'}</code>
        <br/>Scientific Name = <code>${cSci || 'NOT FOUND'}</code>
        <br/>Common Name = <code>${cCom || 'NOT FOUND'}</code>
        <br/>ROOT_TYPE = <code>${cRT || 'NOT FOUND'}</code>
        <br/>ROOT_DEPTH = <code>${cRD || 'NOT FOUND'}</code>
      </div>
    `;
    logDebug('üßæ detected CSV columns', { cL3, cType, cSci, cCom, cRT, cRD });

    plants = rows.map(r => ({
      l3Key: cL3 ? String(r[cL3]).trim() : '',
      plantType: cType ? String(r[cType]).trim() : '',
      scientificName: cSci ? String(r[cSci]).trim() : '',
      commonName: cCom ? String(r[cCom]).trim() : '',
      rootType: cRT ? String(r[cRT]).trim() : '',
      rootDepth: cRD ? String(r[cRD]).trim() : ''
    }));

    indexPlantsByL3();
    rebuildTypeDropdown();
    setStatus(`Loaded ${plants.length.toLocaleString()} rows from CSV.`);
  }

  // ============================================================
  // Load map GeoJSON
  // ============================================================
  async function loadEcoregionsGeoJSON() {
    setStatus('Loading ecoregion map‚Ä¶');
    logDebug('‚û°Ô∏è fetch GeoJSON', ECOREGIONS_URL);

    const res = await fetch(ECOREGIONS_URL, { cache: 'no-store' });
    logDebug('‚¨ÖÔ∏è GeoJSON status', res.status);

    if (!res.ok) throw new Error(`Failed to load map JSON: ${res.status}`);

    const geojson = await res.json();
    logDebug('‚úÖ GeoJSON parsed', { type: geojson.type, features: geojson.features?.length });

    function onEachFeature(feature, layer) {
      layer.on('click', () => {
        const p = feature.properties || {};
        selectedL3Key = p.L3_KEY || null;
        selectedL3Name = p.US_L3NAME || p.NA_L3NAME || null;

        elSelected.textContent = selectedL3Key
          ? (selectedL3Name ? `${selectedL3Key} ‚Äî ${selectedL3Name}` : selectedL3Key)
          : 'Unknown region';

        logDebug('üó∫Ô∏è region clicked', { selectedL3Key, selectedL3Name });
        renderResults();
      });
    }

    L.geoJSON(geojson, { onEachFeature }).addTo(map);
    setStatus('Map loaded. Click an ecoregion!');
  }

  // UI events
  elTypeFilter.addEventListener('change', renderResults);
  elSearch.addEventListener('input', renderResults);

  // ============================================================
  // Boot (loads map even if CSV fails)
  // ============================================================
  (async function start() {
    try {
      logDebug('üöÄ App starting', { ECOREGIONS_URL, DATABASE_CSV_URL });

      await loadEcoregionsGeoJSON();

      try {
        await loadPlantDatabaseCSV();
      } catch (e) {
        logDebug('‚ùå CSV failed to load', String(e));
        setStatus('ERROR loading CSV: ' + e.message);
        openDebug();
      }

      renderResults();
      logDebug('‚úÖ App ready');
    } catch (err) {
      logDebug('‚ùå App start error', String(err));
      setStatus('ERROR: ' + err.message);
      openDebug();
    }
  })();
</script>
</body>
</html>
