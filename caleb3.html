<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-green: #1a5d1a;
      --accent-green: #27ae60;
      --bg-light: #e8f5e9;
      --card-bg: #f9f6f2;
      --border-color: #cbd5e0;
      --text-main: #2d3436;
      --soft-radius: 12px;
    }

    body { margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text-main); line-height: 1.5; overflow: hidden; }
    #wrap { display: grid; grid-template-columns: 550px 1fr; height: 100vh; }
    #sidebar { padding: 30px; border-right: 1px solid var(--border-color); overflow-y: auto; overflow-x: hidden; background: var(--bg-light); z-index: 10; scroll-behavior: smooth; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    
    h2 { margin: 0 0 4px; color: var(--primary-green); font-size: 2.4em; letter-spacing: -1px; font-weight: 800; }
    .acronym { font-size: 0.8em; color: var(--accent-green); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .subtitle { margin-bottom: 30px; color: #4a5568; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
    
    #secret-dot { cursor: pointer; user-select: none; transition: opacity 0.2s; }
    h3 { margin: 35px 0 15px; font-size: 0.9em; border-bottom: 2px solid #cbd5e0; padding-bottom: 8px; color: #475569; text-transform: uppercase; letter-spacing: 1px; }
    
    .btn-standard { width: 100%; border: none; padding: 14px; border-radius: var(--soft-radius); font-weight: 700; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; }
    #geo-btn { background: #3b82f6; color: white; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2); }
    .zip-container { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; width: 100%; }
    .input-group { display: flex; flex: 1; gap: 10px; }

    input[type="text"], input[type="number"], select { flex: 1; min-width: 0; padding: 12px; border: 1.5px solid var(--border-color); border-radius: var(--soft-radius); font-size: 0.9em; height: 48px; box-sizing: border-box; transition: border-color 0.2s; background: #fff; }
    .action-btn { background: var(--accent-green); color: white; border: none; padding: 0 24px; border-radius: var(--soft-radius); font-weight: 700; cursor: pointer; height: 48px; transition: background 0.2s; flex-shrink: 0; }
    .export-btn { flex: 1; padding: 12px; border-radius: var(--soft-radius); border: 1.5px solid var(--accent-green); background: #fff; color: var(--accent-green); font-weight: 700; cursor: pointer; font-size: 0.8em; transition: all 0.2s; }

    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    label { font-weight: 700; font-size: 0.7em; display: block; margin-bottom: 4px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; }
    .soil-desc { font-size: 0.65em; color: #718096; margin-bottom: 10px; line-height: 1.2; font-style: italic; }

    #selected-region { background: #e6f0ff; padding: 12px; border-radius: 12px; font-weight: bold; margin-bottom: 10px; color: #1e40af; border: 1px solid #cbd5e0; }

    .plant-card { border: 1px solid #d2b48c; padding: 20px; margin-bottom: 20px; border-radius: var(--soft-radius); background: var(--card-bg); position: relative; }
    .plant-card h4 { margin: 0 0 6px; color: var(--text-main); font-size: 1.25em; font-weight: 800; padding-right: 35px; }
    .plant-img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; margin: 12px 0 8px; background: #e2e8f0; display: block; }
    .soil-badge { background: #e2e8f0; color: #2d3436; font-size: 0.7em; font-weight: 700; padding: 4px 10px; border-radius: 6px; text-transform: uppercase; border: 1px solid var(--border-color); margin-right: 4px; display: inline-block; }
    
    .star-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 1.6em; cursor: pointer; color: #cbd5e0; line-height: 1; }
    .star-btn.active { color: #f1c40f; }

    #starred-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 20000; overflow-y: auto; padding: 40px 20px; }
    .close-starred { font-size: 35px; cursor: pointer; color: white; background: none; border: none; float: right; }

    #map-controls { position: absolute; top: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .map-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 700; font-size: 0.8em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    #debug-overlay { display: none; position: fixed; top: 10%; left: 10%; right: 10%; bottom: 10%; background: #0f172a; color: #10b981; font-family: monospace; padding: 25px; z-index: 10000; border-radius: var(--soft-radius); flex-direction: column; }
    #debug-content { flex-grow: 1; overflow-y: auto; background: #1e293b; padding: 15px; border-radius: 8px; font-size: 12px; white-space: pre-wrap; margin-top: 10px; }
  </style>
</head>
<body>

<div id="starred-overlay">
  <button class="close-starred" onclick="document.getElementById('starred-overlay').style.display='none'">‚úï</button>
  <h2 style="color:white; clear:both; padding-top:10px;">‚≠ê Starred Comparisons</h2>
  <div id="starred-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-top:30px;"></div>
</div>

<div id="debug-overlay">
  <div style="display:flex; justify-content: space-between; align-items: center;">
    <span style="font-weight: bold; letter-spacing: 1px;">SYSTEM LOGS</span>
    <div style="display: flex; gap: 10px;">
      <button onclick="copyDebugLog()" style="padding: 5px 15px; cursor:pointer;">Copy</button>
      <button onclick="clearDebugLog()" style="padding: 5px 15px; cursor:pointer;">Clear</button>
      <button onclick="document.getElementById('debug-overlay').style.display='none'" style="background:#ef4444; color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">Close</button>
    </div>
  </div>
  <div id="debug-content"></div>
</div>

<div id="wrap">
  <div id="sidebar">
    <h2>S<span id="secret-dot">.</span>P.A.D.E.</h2>
    <div class="acronym">Site Preservation & Dirt Erosion</div>
    <div class="subtitle">Created By The Blazin Turtles</div>
    
    <button id="geo-btn" class="btn-standard" onclick="useMyLocation()">üìç Use My Location</button>
    <div class="zip-container"><input type="text" id="zip-input" placeholder="Zip Code" maxlength="5"><button class="action-btn" onclick="useZipCode()">Go</button></div>
    <div class="zip-container"><div class="input-group"><input type="number" id="lat-input" placeholder="Lat" step="any"><input type="number" id="lng-input" placeholder="Lng" step="any"></div><button class="action-btn" onclick="useCoordinates()">Go</button></div>

    <button class="btn-standard" style="background: #f1c40f; color: #2d3436; margin-bottom: 25px;" onclick="showStarred()">‚≠ê View Starred Plants</button>

    <div class="row">
      <label>Target Ecoregion</label>
      <div id="selected-region">Select a site on the map</div>
      <button class="btn-standard" style="background: #fed7d7; color: #c53030; height: 35px; padding: 0;" onclick="resetSelection()">Clear Selection</button>
    </div>

    <input type="text" id="search-box" placeholder="Search Plants..." style="width:100%; margin: 20px 0;" />

    <h3>Filters</h3>
    <div class="filter-grid">
      <div class="row"><label>Type</label><select id="type-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Roots</label><select id="root-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Moisture</label><select id="moisture-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Sun</label><select id="sun-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Drought</label><select id="drought-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Fire</label><select id="fire-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Growth</label><select id="growth-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Season</label><select id="season-filter" class="plant-filter"><option value="all">Any</option><option value="Spring">Spring</option><option value="Fall">Fall</option><option value="Summer">Summer</option><option value="Winter">Winter</option><option value="Year Round">Year Round</option></select></div>
    </div>

    <h3>Soil</h3>
    <div class="filter-grid">
      <div class="row"><label>Clay</label><select id="clay-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Sand</label><select id="sand-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Gravel</label><select id="gravel-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
      <div class="row"><label>Loam</label><select id="loam-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
    </div>

    <button class="reset-filters-btn" onclick="resetFilters()">Reset All Filters</button>

    <div id="results-count">Ready...</div>
    <div class="export-row" style="display:flex; gap:10px;"><button class="export-btn" onclick="exportExcel()">Export XLSX</button><button class="export-btn" onclick="exportCSV()">Export CSV</button></div>
    <div id="results-list"></div>
    <div id="show-more-container" style="text-align:center; margin-top:20px; display:none;"><button class="action-btn" style="width:100%;" onclick="showMore()">Show More</button></div>
  </div>

  <div id="map-container">
    <div id="map-controls">
      <button class="map-btn" onclick="setMapLayer('street')">Site Map</button>
      <button class="map-btn" onclick="setMapLayer('satellite')">Satellite View</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script>
  function sysLog(msg) { const content = document.getElementById('debug-content'); content.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`; content.scrollTop = content.scrollHeight; }
  function copyDebugLog() { const text = document.getElementById('debug-content').innerText; navigator.clipboard.writeText(text); alert("Logs copied to clipboard."); }
  function clearDebugLog() { document.getElementById('debug-content').innerHTML = ""; sysLog("Logs cleared."); }

  let plantData = null, currentFilteredItems = [], selectedL3Key = null, displayLimit = 10, map, geoLayer; 
  let starredPlants = JSON.parse(localStorage.getItem('spade_starred') || '[]');
  const increment = 10, ECO_URL = 'assets/us_eco_l3_state_boundaries.json', CSV_URL = 'assets/Database-Deleted-Categories.csv';

  const vendorLinkMap = {
    "native west": { name: "Native West Nursery", url: "https://nativewest.com/" },
    "prairie moon nursery": { name: "Prairie Moon Nursery", url: "https://www.prairiemoon.com/" },
    "praire nursery": { name: "Prairie Nursery", url: "https://www.prairienursery.com/" },
    "ernst seeds": { name: "Ernst Conservation Seeds", url: "https://www.ernstseed.com/" },
    "gbnp": { name: "Great Bear Native Plants", url: "http://www.greatbearnativeplants.com/" },
    "mellow marsh farm": { name: "Mellow Marsh Farm", url: "https://mellowmarshfarm.com/" },
    "roots and shoots": { name: "Roots and Shoots Nursery", url: "https://www.rootsandshootsnursery.com/" },
    "critsite_native_plants_full_list": { name: "Plant Picker", url: "https://plantsman.com/" }
  };

  const streetTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
  const satelliteTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

  function setMapLayer(type) { sysLog("Switching Map: " + type); if (type === 'satellite') { map.removeLayer(streetTiles); satelliteTiles.addTo(map); } else { map.removeLayer(satelliteTiles); streetTiles.addTo(map); } }

  // Restored Focus (Highlight/Blur) Feature
  function highlightRegion(key) {
    if (!geoLayer) return;
    sysLog("Focusing region: " + key);
    geoLayer.eachLayer(layer => {
      if (layer.feature.properties.L3_KEY === key) {
        layer.setStyle({ fillOpacity: 0.7, weight: 4, color: '#1a5d1a' });
        layer.bringToFront();
      } else {
        layer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#cccccc' });
      }
    });
  }

  function toggleStar(sciName, l3key, isOverlay = false) {
    const starId = `${sciName}|${l3key || 'Global'}`;
    const idx = starredPlants.indexOf(starId);
    if (idx === -1) { starredPlants.push(starId); sysLog("Starred: " + starId); }
    else { starredPlants.splice(idx, 1); sysLog("Unstarred: " + starId); }
    localStorage.setItem('spade_starred', JSON.stringify(starredPlants));
    renderResults(false);
    if(isOverlay) showStarred();
  }

  function showStarred() {
    sysLog("Opening Starred Overlay");
    const grid = document.getElementById('starred-grid'); grid.innerHTML = '';
    const items = plantData.filter(p => starredPlants.includes(`${p['Scientific Name']}|${p['L3_KEY'] || 'Global'}`));
    if (items.length === 0) grid.innerHTML = '<p style="color:white; text-align:center; width:100%;">No starred plants yet.</p>';
    items.forEach((p, idx) => {
      const card = createPlantCard(p, `fav-${idx}`, true);
      grid.appendChild(card);
      loadPlantPhoto(p['Scientific Name'], `img-fav-${idx}`);
    });
    document.getElementById('starred-overlay').style.display = 'block';
  }

  function createPlantCard(p, uniqueId, isOverlay = false) {
    const starId = `${p['Scientific Name']}|${p['L3_KEY'] || 'Global'}`;
    const isStarred = starredPlants.includes(starId);
    const card = document.createElement('div'); card.className = 'plant-card';
    let soils = []; ['CLAY','SAND','GRAVEL','LOAM','SILT','PEAT','CHALKY'].forEach(s => { if(p[s+'_SOIL'] === 'Yes') soils.push(`<span class="soil-badge">${s}</span>`); });
    const vendorLink = vendorLinkMap[(p['Vendor'] || '').toLowerCase().trim()] ? `<a href="${vendorLinkMap[(p['Vendor'] || '').toLowerCase().trim()].url}" target="_blank" style="color:var(--accent-green); text-decoration:none;">${vendorLinkMap[(p['Vendor'] || '').toLowerCase().trim()].name}</a>` : p['Vendor'] || 'N/A';
    let det = ''; Object.keys(p).forEach(k => { if(p[k] && p[k] !== '0') det += `<div><strong>${k.replace(/_/g,' ')}</strong><span>${p[k]}</span></div>`; });
    card.innerHTML = `<button class="star-btn ${isStarred?'active':''}" onclick="toggleStar('${p['Scientific Name']}', '${p['L3_KEY']}', ${isOverlay})">‚òÖ</button><h4>${p['Common Name'] || 'Species'}</h4><p><em>${p['Scientific Name']}</em></p><img id="img-${uniqueId}" class="plant-img"><div class="soil-category-container">${soils.join('')}</div><p><strong>Roots:</strong> ${p['ROOT_TYPE'] || 'N/A'}</p><p><strong>Sun:</strong> ${p['SUN_EXPOSURE'] || 'N/A'}</p><p><strong>Moisture:</strong> ${p['Soil Moisture'] || 'N/A'}</p><p><strong>Nursery:</strong> ${vendorLink}</p><div class="card-actions" style="display:flex; gap:10px; margin-top:10px;"><button class="more-info-btn" onclick="toggleDetails('${uniqueId}')">Details</button><a href="${p['SOURCE_LINK_1']}" target="_blank" class="source-link">USDA Profile</a></div><div id="details-${uniqueId}" class="details-pane">${det}</div>`;
    return card;
  }

  async function loadPlantPhoto(sciName, imgId) {
    const img = document.getElementById(imgId); if(!img) return;
    try {
      const res = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(sciName)}&rank=species`);
      const data = await res.json(); if (data.results?.[0]?.default_photo) img.src = data.results[0].default_photo.medium_url; else img.style.display = 'none';
    } catch (e) { img.style.display = 'none'; }
  }

  function toggleDetails(id) { document.getElementById(`details-${id}`).classList.toggle('active'); }

  function renderResults(resetLimit = true) {
    if (!plantData) return; if (resetLimit) displayLimit = 10;
    const q = document.getElementById('search-box').value.toLowerCase();
    const f = { type: document.getElementById('type-filter').value, root: document.getElementById('root-filter').value, moisture: document.getElementById('moisture-filter').value, sun: document.getElementById('sun-filter').value, drought: document.getElementById('drought-filter').value, fire: document.getElementById('fire-filter').value, growth: document.getElementById('growth-filter').value, season: document.getElementById('season-filter').value, clay: document.getElementById('clay-filter').value, sand: document.getElementById('sand-filter').value, gravel: document.getElementById('gravel-filter').value, loam: document.getElementById('loam-filter').value };

    currentFilteredItems = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (f.type !== 'all' && !(p['Plant Type'] || '').includes(f.type)) return false;
      if (f.root !== 'all' && !(p['ROOT_TYPE'] || '').includes(f.root)) return false;
      if (f.moisture !== 'all' && !(p['Soil Moisture'] || '').includes(f.moisture)) return false;
      if (f.sun !== 'all' && !(p['SUN_EXPOSURE'] || '').includes(f.sun)) return false;
      if (f.clay !== 'all' && p['CLAY_SOIL'] !== f.clay) return false;
      if (f.sand !== 'all' && p['SAND_SOIL'] !== f.sand) return false;
      if (q && !((p['Common Name'] || '').toLowerCase().includes(q) || (p['Scientific Name'] || '').toLowerCase().includes(q))) return false;
      return true;
    });
    
    sysLog("Matches found: " + currentFilteredItems.length);
    document.getElementById('results-count').textContent = `Matched ${currentFilteredItems.length} Species`;
    document.getElementById('show-more-container').style.display = (currentFilteredItems.length > displayLimit) ? 'block' : 'none';
    const list = document.getElementById('results-list'); list.innerHTML = '';
    currentFilteredItems.slice(0, displayLimit).forEach((p, idx) => {
      const card = createPlantCard(p, `list-${idx}`, false);
      list.appendChild(card); loadPlantPhoto(p['Scientific Name'], `img-list-${idx}`);
    });
  }

  async function reverseLookupZip(lat, lng) {
    sysLog(`Syncing Zip for ${lat}, ${lng}`);
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
      const data = await res.json(); if (data.address && data.address.postcode) document.getElementById('zip-input').value = data.address.postcode.split('-')[0];
    } catch (e) {}
  }

  function matchLocationToRegion(lat, lng, source) {
    const results = leafletPip.pointInLayer([lng, lat], geoLayer);
    if (results.length > 0) {
      selectedL3Key = results[0].feature.properties.L3_KEY;
      document.getElementById('selected-region').textContent = `${selectedL3Key}: ${results[0].feature.properties.US_L3NAME}`;
      map.setView([lat, lng], 8);
      document.getElementById('lat-input').value = lat.toFixed(4);
      document.getElementById('lng-input').value = lng.toFixed(4);
      highlightRegion(selectedL3Key);
      if (source !== 'zip') reverseLookupZip(lat, lng);
      renderResults(true);
    }
  }

  function useMyLocation() { sysLog("Attempting Geolocation..."); navigator.geolocation.getCurrentPosition(pos => matchLocationToRegion(pos.coords.latitude, pos.coords.longitude, 'geo')); }
  async function useZipCode() { const zip = document.getElementById('zip-input').value; sysLog("Go Zip: " + zip); if(zip.length===5) { const res = await fetch(`https://api.zippopotam.us/us/${zip}`); const data = await res.json(); matchLocationToRegion(parseFloat(data.places[0].latitude), parseFloat(data.places[0].longitude), 'zip'); } }
  function useCoordinates() { const lat = parseFloat(document.getElementById('lat-input').value), lng = parseFloat(document.getElementById('lng-input').value); sysLog("Go Coords: " + lat + ", " + lng); if(!isNaN(lat)) matchLocationToRegion(lat, lng, 'coords'); }
  function resetSelection() { sysLog("Selection Cleared"); selectedL3Key = null; document.getElementById('selected-region').textContent = "Select a site on the map"; if(geoLayer) geoLayer.eachLayer(l => l.setStyle({ fillOpacity: 0.1, weight: 1, color: '#27ae60' })); map.setView([37.8, -96], 4); renderResults(true); }
  function resetFilters() { sysLog("Filters Cleared"); document.querySelectorAll('.plant-filter').forEach(s => s.value = 'all'); document.getElementById('search-box').value = ""; renderResults(true); }

  function populate(id, col, data) { const sel = document.getElementById(id), vals = new Set(); data.forEach(r => { if(r[col] && r[col] !== '0') r[col].split(',').forEach(v => vals.add(v.trim())); }); Array.from(vals).sort().forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); }); }

  async function init() { 
    sysLog("Initializing Database...");
    Papa.parse(CSV_URL, { download: true, header: true, complete: res => { 
      plantData = res.data; sysLog("Records Loaded: " + plantData.length);
      ['type-filter', 'root-filter', 'moisture-filter', 'sun-filter', 'drought-filter', 'fire-filter', 'growth-filter'].forEach(id => {
        const col = id === 'type-filter' ? 'Plant Type' : id === 'root-filter' ? 'ROOT_TYPE' : id === 'moisture-filter' ? 'Soil Moisture' : id === 'sun-filter' ? 'SUN_EXPOSURE' : id === 'drought-filter' ? 'Drought Tolerance' : id === 'fire-filter' ? 'Fire Tolerance' : 'Active Growth Period';
        populate(id, col, plantData);
      });
      renderResults(); loadMap(); 
    }}); 
  }

  async function loadMap() {
    sysLog("Loading Map Layers...");
    map = L.map('map').setView([37.8, -96], 4); streetTiles.addTo(map);
    try {
      const res = await fetch(ECO_URL), geoJSON = await res.json();
      geoLayer = L.geoJSON(geoJSON, { style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 }, onEachFeature: (f, l) => {
        const key = f.properties.L3_KEY;
        l.bindTooltip(`<b>${key}</b>: ${f.properties.US_L3NAME}`, { sticky: true });
        // Restored Hover & Selection Events
        l.on({
          mouseover: () => { if(key !== selectedL3Key) l.setStyle({ fillOpacity: 0.35, weight: 2 }); },
          mouseout: () => { if(key !== selectedL3Key) l.setStyle({ fillOpacity: 0.1, weight: 1 }); },
          click: () => { 
            selectedL3Key = key; sysLog("Region selected: " + key);
            document.getElementById('selected-region').textContent = `${key}: ${f.properties.US_L3NAME}`;
            highlightRegion(key); renderResults(true); 
          }
        });
      }}).addTo(map);
    } catch (e) { sysLog("Map Data Error: " + e); }
  }

  window.onload = init;
  document.querySelectorAll('select, input').forEach(el => el.addEventListener('change', () => renderResults(true)));
  let dCount=0, dTimer; document.getElementById('secret-dot').addEventListener('click', () => { dCount++; clearTimeout(dTimer); if(dCount===2) { if(prompt("Key:")==="numpy") document.getElementById('debug-overlay').style.display='flex'; dCount=0; } dTimer=setTimeout(()=>dCount=0, 500); });
</script>
</body>
</html>