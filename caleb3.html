<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #2d3436; }
    #wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    
    #sidebar { padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10; }
    #map-container { position: relative; height: 100vh; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    
    h2 { margin: 0 0 2px; color: #1a5d1a; font-size: 2.2em; letter-spacing: 2px; }
    .acronym { font-size: 0.85em; color: #27ae60; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; }
    .subtitle { margin-bottom: 20px; color: #636e72; font-weight: bold; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Secret Trigger Styling */
    #secret-dot { cursor: default; user-select: none; }

    h3 { margin: 25px 0 10px; font-size: 1em; border-bottom: 2px solid #27ae60; padding-bottom: 5px; color: #27ae60; text-transform: uppercase; }
    
    #geo-btn { 
      width: 100%; background: #2980b9; color: white; border: none; padding: 12px; 
      border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
      transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    #geo-btn:hover { background: #1f6391; }
    #geo-btn:disabled { background: #bdc3c7; cursor: not-allowed; }

    .zip-container { display: flex; gap: 5px; margin-bottom: 15px; }
    #zip-input, #lat-input, #lng-input { flex-grow: 1; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.9em; min-width: 0; }
    .action-btn { background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }

    .export-row { display: flex; gap: 10px; margin: 15px 0; }
    .export-btn { 
      flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #27ae60; 
      background: white; color: #27ae60; font-weight: bold; cursor: pointer; font-size: 0.75em;
      transition: all 0.2s;
    }
    .export-btn:hover { background: #27ae60; color: white; }

    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row { margin-bottom: 12px; }
    label { font-weight: bold; font-size: 0.8em; display: block; margin-bottom: 4px; color: #4b4b4b; }
    select, input[type=\"text\"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.85em; }
    
    .region-display-container { display: flex; align-items: center; gap: 8px; }
    #selected-region { flex-grow: 1; font-weight: bold; color: #2980b9; background: #e1f0fa; padding: 8px; border-radius: 6px; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #clear-selection-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.75em; transition: background 0.2s; }
    #clear-selection-btn:hover { background: #c0392b; }

    .reset-filters-btn { width: 100%; background: #f8f9fa; border: 1px solid #cbd5e0; color: #4b4b4b; padding: 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; cursor: pointer; margin-top: 5px; margin-bottom: 15px; }
    .reset-filters-btn:hover { background: #e2e8f0; }

    .plant-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; border-left: 5px solid #27ae60; }
    .plant-card h4 { margin: 0 0 5px; color: #2d3436; font-size: 1.1em; }
    .plant-card p { margin: 5px 0; font-size: 0.9em; }
    
    .card-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    .source-link { display: inline-block; color: #27ae60; text-decoration: none; font-weight: bold; font-size: 0.8em; border: 1px solid #27ae60; padding: 4px 10px; border-radius: 4px; }
    .source-link:hover { background: #27ae60; color: white; }
    .more-info-btn { background: #f1f3f5; border: 1px solid #dee2e6; color: #495057; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .details-pane { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.8em; color: #444; }
    .details-pane.active { display: block; }
    .details-pane div { margin: 4px 0; border-bottom: 1px solid #f9f9f9; padding-bottom: 2px; }
    .details-pane strong { color: #1a5d1a; text-transform: uppercase; font-size: 0.75em; display: inline-block; width: 130px; }

    #show-more-container { text-align: center; margin: 20px 0; display: none; }
    #show-more-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9em; width: 100%; }
    #results-count { margin: 15px 0; font-weight: bold; font-size: 0.9em; color: #27ae60; }
    #status { font-size: 11px; color: #e67e22; margin-top: 10px; font-style: italic; }

    #debug-overlay {
      display: none; position: fixed; top: 10%; left: 10%; right: 10%; bottom: 10%;
      background: #1e1e1e; color: #00ff00; font-family: 'Consolas', monospace; padding: 20px; z-index: 10000;
      border: 2px solid #333; border-radius: 8px; flex-direction: column;
    }
    #debug-content { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-size: 12px; border: 1px solid #333; padding: 10px; margin-top: 10px; }
    .debug-toolbar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .debug-btn { background: #444; color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .debug-btn:hover { background: #555; }
    .debug-btn.close-btn { background: #c0392b; }
    .debug-btn.close-btn:hover { background: #e74c3c; }

    .leaflet-tooltip-custom { background: rgba(26, 93, 26, 0.9); color: white; border: none; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
  </style>
</head>
<body>

<div id=\"debug-overlay\">
  <div class=\"debug-toolbar\">
    <span style=\"color: #27ae60; font-weight: bold;\">S.P.A.D.E. INTERNAL SYSTEM LOG</span>
    <div style=\"display: flex; gap: 8px;\">
      <button class=\"debug-btn\" onclick=\"copyDebugLog()\">Copy</button>
      <button class=\"debug-btn\" onclick=\"clearDebugLog()\">Clear</button>
      <button class=\"debug-btn close-btn\" onclick=\"document.getElementById('debug-overlay').style.display = 'none'\">Close</button>
    </div>
  </div>
  <div id=\"debug-content\"></div>
</div>

<div id=\"wrap\">
  <div id=\"sidebar\">
    <h2>S<span id=\"secret-dot\">.</span>P.A.D.E.</h2>
    <div class=\"acronym\">SITE PRESERVATION AND DIRT EROSION-CONTROL</div>
    <div class=\"subtitle\">Created by the Blazin Turtles</div>
    
    <button id=\"geo-btn\" onclick=\"useMyLocation()\">üìç Use My Current Location</button>

    <div class=\"zip-container\">
      <input type=\"text\" id=\"zip-input\" placeholder=\"Enter Zip Code\" maxlength=\"5\">
      <button class=\"action-btn\" onclick=\"useZipCode()\">Go</button>
    </div>

    <div class=\"zip-container\">
      <input type=\"number\" id=\"lat-input\" placeholder=\"Latitude\" step=\"any\">
      <input type=\"number\" id=\"lng-input\" placeholder=\"Longitude\" step=\"any\">
      <button class=\"action-btn\" onclick=\"useCoordinates()\" style=\"background: #2980b9;\">Go</button>
    </div>

    <div class=\"row\">
      <label>Target Excavation Ecoregion</label>
      <div class=\"region-display-container\">
        <div id=\"selected-region\">Click map or use location</div>
        <button id=\"clear-selection-btn\" onclick=\"resetSelection()\">Clear</button>
      </div>
    </div>

    <div class=\"row\">
      <label for=\"search-box\">Quick Search</label>
      <input type=\"text\" id=\"search-box\" placeholder=\"e.g. Oak, Sagebrush...\" />
    </div>

    <h3>Stability & Growth</h3>
    <div class=\"filter-grid\">
      <div class=\"row\"><label>Plant Type</label><select id=\"type-filter\" class=\"plant-filter\"><option value=\"all\">Any Type</option></select></div>
      <div class=\"row\"><label>Root Type</label><select id=\"root-filter\" class=\"plant-filter\"><option value=\"all\">Any Root</option></select></div>
      <div class=\"row\"><label>Moisture</label><select id=\"moisture-filter\" class=\"plant-filter\"><option value=\"all\">Any</option></select></div>
      <div class=\"row\"><label>Sun</label><select id=\"sun-filter\" class=\"plant-filter\"><option value=\"all\">Any</option></select></div>
      <div class=\"row\"><label>Drought Tol.</label><select id=\"drought-filter\" class=\"plant-filter\"><option value=\"all\">Any</option></select></div>
      <div class=\"row\"><label>Fire Tol.</label><select id=\"fire-filter\" class=\"plant-filter\"><option value=\"all\">Any</option></select></div>
    </div>

    <h3>Soil Analysis</h3>
    <div class=\"filter-grid\">
      <div class=\"row\"><label>Clay</label><select id=\"clay-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Sand</label><select id=\"sand-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Gravel</label><select id=\"gravel-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Loam</label><select id=\"loam-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Silt</label><select id=\"silt-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Peat</label><select id=\"peat-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
      <div class=\"row\"><label>Chalky</label><select id=\"chalky-filter\" class=\"plant-filter\"><option value=\"all\">Any</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option></select></div>
    </div>

    <button class=\"reset-filters-btn\" onclick=\"resetFilters()\">Reset All Filters</button>

    <div id=\"status\">System starting...</div>
    <div id=\"results-count\"></div>

    <div class=\"export-row\">
      <button class=\"export-btn\" onclick=\"exportExcel()\">Export to Excel</button>
      <button class=\"export-btn\" onclick=\"exportSheets()\">Export for Sheets</button>
    </div>

    <div id=\"results-list\"></div>
    <div id=\"show-more-container\"><button id=\"show-more-btn\" onclick=\"showMore()\">Show More Results</button></div>
  </div>

  <div id=\"map-container\"><div id=\"map\"></div></div>
</div>

<script>
  let plantData = null, currentFilteredItems = [], selectedL3Key = null, regionCounts = {}, displayLimit = 10, map, geoLayer; 
  const increment = 10, ECO_URL = 'assets/us_eco_l3_state_boundaries.json', CSV_URL = 'assets/Database-Deleted-Categories.csv';

  // Secret Debug Initialization
  let dotClickCount = 0;
  let dotTimer;
  document.getElementById('secret-dot').addEventListener('click', () => {
    dotClickCount++;
    clearTimeout(dotTimer);
    if (dotClickCount === 2) {
      const accessCode = prompt(\"Enter Authentication Key:\");
      if (accessCode === \"blazin turtles\") {
        document.getElementById('debug-overlay').style.display = 'flex';
        sysLog(\"SYSTEM LOG ACCESS GRANTED.\");
      } else if (accessCode !== null) {
        sysLog(\"UNAUTHORIZED ACCESS ATTEMPT DETECTED.\");
      }
      dotClickCount = 0;
    } else {
      dotTimer = setTimeout(() => { dotClickCount = 0; }, 500);
    }
  });

  function sysLog(msg) {
    const content = document.getElementById('debug-content');
    if(content) {
        content.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\\n`;
        content.scrollTop = content.scrollHeight;
    }
  }

  function clearDebugLog() { document.getElementById('debug-content').innerHTML = ''; sysLog(\"Log manually cleared.\"); }
  
  function copyDebugLog() {
    const text = document.getElementById('debug-content').innerText;
    navigator.clipboard.writeText(text).then(() => {
      alert(\"System log copied to clipboard.\");
      sysLog(\"Log content copied to clipboard.\");
    });
  }

  function showMore() { 
    displayLimit += increment; 
    sysLog(`Results expansion requested. New limit: ${displayLimit}`);
    renderResults(false); 
  }

  function populate(id, col, data) {
    const sel = document.getElementById(id), vals = new Set();
    data.forEach(r => { if(r[col] && r[col] !== '0') r[col].split(',').forEach(v => vals.add(v.trim())); });
    Array.from(vals).sort().forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
  }

  function highlightRegion(key) {
    if (!geoLayer) return;
    sysLog(`Highlighting map feature: ${key}`);
    geoLayer.eachLayer(layer => {
      if (layer.feature.properties.L3_KEY === key) {
        layer.setStyle({ fillOpacity: 0.6, weight: 3, color: '#1a5d1a', opacity: 1 });
        layer.bringToFront();
      } else {
        layer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#27ae60', opacity: 0.3 });
      }
    });
  }

  function resetFilters() {
    sysLog(\"Resetting all plant filters to default 'all'.\");
    document.getElementById('search-box').value = \"\";
    document.querySelectorAll('.plant-filter').forEach(select => select.value = 'all');
    renderResults(true);
  }

  function resetSelection() {
    sysLog(\"Clearing ecoregion selection and resetting map view.\");
    selectedL3Key = null;
    document.getElementById('selected-region').textContent = \"Click map or use location\";
    ['zip-input', 'lat-input', 'lng-input'].forEach(id => document.getElementById(id).value = \"\");
    if (geoLayer) geoLayer.eachLayer(layer => layer.setStyle({ fillOpacity: 0.1, weight: 1, color: '#27ae60', opacity: 1 }));
    map.setView([37.8, -96], 4);
    renderResults(true);
  }

  function renderResults(resetLimit = true) {
    if (!plantData) return;
    if (resetLimit) displayLimit = 10;

    const query = document.getElementById('search-box').value.toLowerCase();
    const f = {
      type: document.getElementById('type-filter').value,
      root: document.getElementById('root-filter').value,
      moisture: document.getElementById('moisture-filter').value,
      sun: document.getElementById('sun-filter').value,
      drought: document.getElementById('drought-filter').value,
      fire: document.getElementById('fire-filter').value,
      clay: document.getElementById('clay-filter').value,
      sand: document.getElementById('sand-filter').value,
      gravel: document.getElementById('gravel-filter').value,
      loam: document.getElementById('loam-filter').value,
      silt: document.getElementById('silt-filter').value,
      peat: document.getElementById('peat-filter').value,
      chalky: document.getElementById('chalky-filter').value
    };

    currentFilteredItems = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (f.type !== 'all' && !(p['Plant Type'] || '').includes(f.type)) return false;
      if (f.root !== 'all' && !(p['ROOT_TYPE'] || '').includes(f.root)) return false;
      if (f.moisture !== 'all' && !(p['Soil Moisture'] || '').includes(f.moisture)) return false;
      if (f.sun !== 'all' && !(p['SUN_EXPOSURE'] || '').includes(f.sun)) return false;
      if (f.drought !== 'all' && !(p['Drought Tolerance'] || '').includes(f.drought)) return false;
      if (f.fire !== 'all' && !(p['Fire Tolerance'] || '').includes(f.fire)) return false;
      if (f.clay !== 'all' && p['CLAY_SOIL'] !== f.clay) return false;
      if (f.sand !== 'all' && p['SAND_SOIL'] !== f.sand) return false;
      if (f.gravel !== 'all' && p['GRAVEL_SOIL'] !== f.gravel) return false;
      if (f.loam !== 'all' && p['LOAM_SOIL'] !== f.loam) return false;
      if (f.silt !== 'all' && p['SILT_SOIL'] !== f.silt) return false;
      if (f.peat !== 'all' && p['PEAT_SOIL'] !== f.peat) return false;
      if (f.chalky !== 'all' && p['CHALKY_SOIL'] !== f.chalky) return false;
      if (query && !((p['Common Name'] || '').toLowerCase().includes(query) || (p['Scientific Name'] || '').toLowerCase().includes(query))) return false;
      return true;
    });

    sysLog(`Filter applied. Results found: ${currentFilteredItems.length}`);
    document.getElementById('results-count').textContent = `Showing ${Math.min(displayLimit, currentFilteredItems.length)} of ${currentFilteredItems.length} matches`;
    document.getElementById('show-more-container').style.display = (currentFilteredItems.length > displayLimit) ? 'block' : 'none';

    const list = document.getElementById('results-list');
    list.innerHTML = '';
    
    currentFilteredItems.slice(0, displayLimit).forEach((p, index) => {
      const card = document.createElement('div');
      card.className = 'plant-card';
      const hasLink = p['SOURCE_LINK_1'] && p['SOURCE_LINK_1'] !== '0';
      const sourceHtml = hasLink ? `<a href=\"${p['SOURCE_LINK_1']}\" target=\"_blank\" class=\"source-link\">View Source</a>` : '';
      let allFieldsHtml = '';
      Object.keys(p).forEach(key => { if(p[key] && p[key] !== '0' && p[key] !== '') allFieldsHtml += `<div><strong>${key}:</strong> ${p[key]}</div>`; });

      card.innerHTML = `
        <h4>${p['Common Name'] || 'Unknown'}</h4>
        <p><em>${p['Scientific Name'] || ''}</em></p>
        <p><strong>ROOTS:</strong> ${p['ROOT_TYPE'] || 'N/A'} (${p['ROOT_DEPTH'] || 'N/A'})</p>
        <p><strong>TOLERANCE:</strong> Drought: ${p['Drought Tolerance'] || 'N/A'}, Fire: ${p['Fire Tolerance'] || 'N/A'}</p>
        <div class=\"card-actions\"><button class=\"more-info-btn\" onclick=\"toggleDetails(${index})\">More Information</button>${sourceHtml}</div>
        <div id=\"details-${index}\" class=\"details-pane\">${allFieldsHtml}</div>
      `;
      list.appendChild(card);
    });
  }

  async function useZipCode() {
    const zip = document.getElementById('zip-input').value;
    if (!/^\\d{5}$/.test(zip)) return;
    sysLog(`Initiating ZIP lookup: ${zip}`);
    try {
      const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
      if (!res.ok) throw new Error(\"ZIP database error.\");
      const data = await res.json();
      const lat = parseFloat(data.places[0].latitude), lng = parseFloat(data.places[0].longitude);
      document.getElementById('lat-input').value = lat;
      document.getElementById('lng-input').value = lng;
      sysLog(`ZIP resolved to ${lat}, ${lng}`);
      matchLocationToRegion(lat, lng);
    } catch (err) { sysLog(`ZIP lookup failure: ${err.message}`); }
  }

  async function useMyLocation() {
    if (!navigator.geolocation) { sysLog(\"Geolocation hardware not detected.\"); return; }
    sysLog(\"Requesting GPS signal...\");
    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        document.getElementById('lat-input').value = lat.toFixed(4);
        document.getElementById('lng-input').value = lng.toFixed(4);
        sysLog(`GPS Lock: ${lat}, ${lng}`);
        matchLocationToRegion(lat, lng);
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
          const data = await res.json();
          if (data.address && data.address.postcode) document.getElementById('zip-input').value = data.address.postcode.split('-')[0];
        } catch (e) { sysLog(\"Reverse geocoding suppressed/failed.\"); }
      }, (err) => sysLog(`GPS Lock Failure: ${err.message}`), { enableHighAccuracy: true });
  }

  function useCoordinates() {
    const lat = parseFloat(document.getElementById('lat-input').value), lng = parseFloat(document.getElementById('lng-input').value);
    if (!isNaN(lat) && !isNaN(lng)) {
      sysLog(`Manual coordinate search: ${lat}, ${lng}`);
      matchLocationToRegion(lat, lng);
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(res => res.json()).then(data => {
          if (data.address && data.address.postcode) document.getElementById('zip-input').value = data.address.postcode.split('-')[0];
        }).catch(() => sysLog(\"Reverse geocoding unavailable for manually entered coords.\"));
    }
  }

  function matchLocationToRegion(lat, lng) {
    const results = leafletPip.pointInLayer([lng, lat], geoLayer);
    if (results.length > 0) {
      const f = results[0].feature;
      selectedL3Key = f.properties.L3_KEY;
      sysLog(`Location successfully mapped to Ecoregion \${selectedL3Key}: \${f.properties.US_L3NAME}`);
      document.getElementById('selected-region').textContent = `\${selectedL3Key}: \${f.properties.US_L3NAME}`;
      map.setView([lat, lng], 8);
      highlightRegion(selectedL3Key);
      renderResults(true);
    } else { sysLog(\"Location validated but falls outside defined Ecoregion boundaries.\"); }
  }

  async function init() {
    sysLog(\"Initializing Database sequence...\");
    Papa.parse(CSV_URL, { download: true, header: true, complete: (res) => {
        plantData = res.data;
        sysLog(`CSV Database Loaded. Records count: \${plantData.length}`);
        plantData.forEach(p => { if(p.L3_KEY) regionCounts[p.L3_KEY] = (regionCounts[p.L3_KEY] || 0) + 1; });
        ['type-filter', 'root-filter', 'moisture-filter', 'sun-filter', 'drought-filter', 'fire-filter'].forEach(id => {
          const col = id === 'type-filter' ? 'Plant Type' : id === 'root-filter' ? 'ROOT_TYPE' : id === 'moisture-filter' ? 'Soil Moisture' : id === 'sun-filter' ? 'SUN_EXPOSURE' : id === 'drought-filter' ? 'Drought Tolerance' : 'Fire Tolerance';
          populate(id, col, plantData);
        });
        document.getElementById('status').textContent = 'Database Active';
        renderResults();
        loadMap();
    }});
  }

  async function loadMap() {
    sysLog(\"Initializing map engine...\");
    map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    try {
      const geoRes = await fetch(ECO_URL);
      const geoJSON = await geoRes.json();
      geoLayer = L.geoJSON(geoJSON, {
        style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
          const key = f.properties.L3_KEY;
          const count = regionCounts[key] || 0;
          const states = f.properties.STATE_NAME || f.properties.STATE || \"N/A\";
          
          l.bindTooltip(`
            <b>Ecoregion:</b> \${key}<br/>
            <b>Name:</b> \${f.properties.US_L3NAME || \"Unknown\"}<br/>
            <b>Plants:</b> \${count}<br/>
            <b>Located in:</b> \${states}
          `, { sticky: true, className: 'leaflet-tooltip-custom' });

          l.on({ 
            mouseover: (e) => e.target.setStyle({ fillOpacity: 0.4 }),
            mouseout: (e) => e.target.setStyle({ fillOpacity: 0.1 }),
            click: (e) => {
              selectedL3Key = key;
              sysLog(`Manual Map Click: \${selectedL3Key}`);
              document.getElementById('selected-region').textContent = `\${selectedL3Key}: \${f.properties.US_L3NAME || \"Region\"}`;
              highlightRegion(selectedL3Key);
              renderResults(true);
          }});
        }
      }).addTo(map);
      sysLog(\"Map layers synchronized successfully.\");
    } catch (e) { sysLog(\"Map Layer Critical Error: \" + e.message); }
  }

  function toggleDetails(idx) { document.getElementById(`details-\${idx}`).classList.toggle('active'); }
  document.querySelectorAll('select, input').forEach(el => el.addEventListener('change', () => renderResults(true)));
  window.onload = init;
</script>

</body>
</html>