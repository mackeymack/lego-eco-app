<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-green: #1a5d1a;
      --accent-green: #27ae60;
      --bg-light: #e8f5e9;
      --card-bg: #f9f6f2;
      --border-color: #cbd5e0;
      --text-main: #2d3436;
      --soft-radius: 12px;
    }

    * { box-sizing: border-box; }
    
    body { 
      margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg-light); 
      color: var(--text-main); line-height: 1.5; overflow-x: hidden; 
      padding-top: env(safe-area-inset-top);
    }
    
    #install-banner {
      display: none; background: var(--primary-green); color: white; padding: 15px;
      position: relative; z-index: 2000; justify-content: space-between; align-items: center;
      font-weight: 700; font-size: 0.85em; border-bottom: 2px solid white;
    }
    .banner-btns { display: flex; gap: 8px; }
    #install-btn { background: white; color: var(--primary-green); border: none; padding: 8px 12px; border-radius: 6px; font-weight: 800; font-size: 0.9em; }
    #ignore-btn { background: transparent; color: white; border: 1px solid white; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; }

    /* Stationary Map at Top */
    #wrap { display: flex; flex-direction: column; width: 100%; }
    
    #map-container { 
      height: 40vh; width: 100%; position: sticky; top: 0; z-index: 1500; 
      background: #ffffff; border-bottom: 2px solid var(--border-color);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #map { height: 100%; width: 100%; }
    
    #sidebar { width: 100%; padding: 15px; background: var(--bg-light); position: relative; z-index: 100; }

    h2 { margin: 0 0 4px; color: var(--primary-green); font-size: 1.8em; letter-spacing: -1px; font-weight: 800; }
    .subtitle { margin-bottom: 20px; color: #4a5568; font-weight: 600; font-size: 0.75em; text-transform: uppercase; }
    #secret-dot { cursor: pointer; user-select: none; touch-action: manipulation; }

    .btn-standard { width: 100%; border: none; padding: 14px; border-radius: var(--soft-radius); font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; margin-bottom: 12px; }
    #geo-btn { background: #3b82f6; color: white; }
    
    /* Responsive Input Containers */
    .input-container { display: flex; gap: 8px; margin-bottom: 12px; width: 100%; }
    .input-group { display: flex; flex: 1; gap: 6px; min-width: 0; }

    input[type="text"], input[type="number"], select { flex: 1; min-width: 0; padding: 10px 8px; border: 1.5px solid var(--border-color); border-radius: var(--soft-radius); font-size: 16px; height: 44px; background: #fff; }
    .action-btn { background: var(--accent-green); color: white; border: none; padding: 0 15px; border-radius: var(--soft-radius); font-weight: 700; height: 44px; flex-shrink: 0; }

    #selected-region { font-weight: 700; color: #1e40af; background: #e6f0ff; padding: 12px; border-radius: var(--soft-radius); font-size: 0.8em; border: 1px solid #cbd5e0; margin-bottom: 15px; text-align: center; }

    /* Starred Section */
    #starred-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; overflow-y: auto; padding: 20px; }
    .starred-header { display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 20px; }
    .close-starred { font-size: 30px; cursor: pointer; color: white; background: none; border: none; }

    /* Filter Grid optimization */
    h3 { margin: 25px 0 10px; font-size: 0.8em; border-bottom: 1px solid #cbd5e0; padding-bottom: 5px; color: #475569; text-transform: uppercase; letter-spacing: 1px; }
    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; width: 100%; }
    label { font-weight: 700; font-size: 0.6em; display: block; margin-bottom: 2px; color: #4a5568; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Plant Card Styling */
    .plant-card { border: 1px solid #d2b48c; padding: 15px; margin-bottom: 15px; border-radius: var(--soft-radius); background: var(--card-bg); position: relative; }
    .plant-img { width: 100%; height: auto; aspect-ratio: 4 / 3; object-fit: cover; border-radius: 8px; margin: 10px 0; background: #e2e8f0; }
    .soil-badge { background: #e2e8f0; color: #2d3436; font-size: 0.6em; font-weight: 700; padding: 3px 8px; border-radius: 5px; text-transform: uppercase; margin-right: 4px; display: inline-block; margin-bottom: 4px; }
    
    .star-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.6em; color: #cbd5e0; line-height: 1; z-index: 50; }
    .star-btn.active { color: #f1c40f; }

    .card-actions { display: flex; gap: 8px; margin-top: 10px; }
    .more-info-btn { flex: 1; background: #f7fafc; border: 1px solid #cbd5e0; color: #4a5568; padding: 10px; border-radius: 8px; font-size: 0.75em; font-weight: 700; }
    .source-link { flex: 1; background: var(--accent-green); color: white; text-align: center; text-decoration: none; padding: 10px; border-radius: 8px; font-size: 0.75em; font-weight: 700; }

    .details-pane { display: none; background: #fff; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 0.7em; border: 1px dashed #ccc; }
    .details-pane div { display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding: 4px 0; }

    #map-controls { position: absolute; top: 10px; right: 10px; z-index: 1600; display: flex; flex-direction: column; gap: 5px; }
    .map-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 6px; padding: 8px; font-weight: 700; font-size: 0.75em; }
    #results-count { margin: 15px 0; font-weight: 800; font-size: 0.85em; color: var(--accent-green); text-align: center; background: #e6fffa; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>

<div id="install-banner">
  <span>Add S.P.A.D.E. to Home Screen?</span>
  <div class="banner-btns">
    <button id="install-btn">Download</button>
    <button id="ignore-btn" onclick="document.getElementById('install-banner').style.display='none'">Ignore</button>
  </div>
</div>

<div id="starred-overlay">
  <div class="starred-header">
    <h2 style="color:white; margin:0;">‚≠ê Starred Plants</h2>
    <button class="close-starred" onclick="document.getElementById('starred-overlay').style.display='none'">‚úï</button>
  </div>
  <div id="starred-list"></div>
</div>

<div id="wrap">
  <div id="map-container">
    <div id="map-controls">
      <button class="map-btn" onclick="setMapLayer('street')">Site Map</button>
      <button class="map-btn" onclick="setMapLayer('satellite')">Satellite View</button>
    </div>
    <div id="map"></div>
  </div>
  
  <div id="sidebar">
    <h2>S<span id="secret-dot">.</span>P.A.D.E.</h2>
    <div class="subtitle">Created By The Blazin Turtles</div>
    
    <button id="geo-btn" class="btn-standard" onclick="useMyLocation()">üìç Use My Location</button>
    
    <div class="input-container">
      <input type="text" id="zip-input" placeholder="Zip Code" maxlength="5">
      <button class="action-btn" onclick="useZipCode()">Go</button>
    </div>

    <div class="input-container">
      <div class="input-group">
        <input type="number" id="lat-input" placeholder="Lat" step="any">
        <input type="number" id="lng-input" placeholder="Lng" step="any">
      </div>
      <button class="action-btn" onclick="useCoordinates()">Go</button>
    </div>

    <button class="btn-standard" style="background: #f1c40f; color: #2d3436;" onclick="showStarred()">‚≠ê View Starred Plants</button>

    <div id="selected-region">Select a site on the map</div>
    <input type="text" id="search-box" placeholder="Search Species..." style="width:100%; margin-bottom:15px;" />

    <h3>Filters</h3>
    <div class="filter-grid" id="filter-grid">
      </div>

    <div id="results-count">Ready...</div>
    <div id="results-list"></div>
    <button id="show-more-btn" class="btn-standard" style="background:var(--accent-green); color:white; margin-top:15px;" onclick="showMore()">Show More</button>
  </div>
</div>

<script>
  let plantData = null, currentFilteredItems = [], selectedL3Key = null, displayLimit = 10, map, geoLayer; 
  let starredPlants = JSON.parse(localStorage.getItem('spade_starred') || '[]');
  const CSV_URL = 'assets/Database-Deleted-Categories.csv';
  const ECO_URL = 'assets/us_eco_l3_state_boundaries.json';

  const vendorLinkMap = {
    "native west": { name: "Native West Nursery", url: "https://nativewest.com/" },
    "prairie moon nursery": { name: "Prairie Moon Nursery", url: "https://www.prairiemoon.com/" },
    "praire nursery": { name: "Prairie Nursery", url: "https://www.prairienursery.com/" },
    "ernst seeds": { name: "Ernst Conservation Seeds", url: "https://www.ernstseed.com/" },
    "gbnp": { name: "Great Bear Native Plants", url: "http://www.greatbearnativeplants.com/" },
    "mellow marsh farm": { name: "Mellow Marsh Farm", url: "https://mellowmarshfarm.com/" },
    "roots and shoots": { name: "Roots and Shoots Nursery", url: "https://www.rootsandshootsnursery.com/" },
    "critsite_native_plants_full_list": { name: "Plant Picker", url: "https://plantsman.com/" }
  };

  const streetTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
  const satelliteTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

  function setMapLayer(type) { if (type === 'satellite') { map.removeLayer(streetTiles); satelliteTiles.addTo(map); } else { map.removeLayer(satelliteTiles); streetTiles.addTo(map); } }

  // Highlight Logic: Selected region is bold, others are "blurred" (dimmed)
  function highlightRegion(key) {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      if (layer.feature.properties.L3_KEY === key) {
        layer.setStyle({ fillOpacity: 0.7, weight: 4, color: '#1a5d1a' });
        layer.bringToFront();
      } else {
        layer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#cccccc' });
      }
    });
  }

  // Cross-filling Location Logic
  async function reverseLookupZip(lat, lng) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
      const data = await res.json();
      if (data.address && data.address.postcode) {
        document.getElementById('zip-input').value = data.address.postcode.split('-')[0];
      }
    } catch (e) {}
  }

  function matchLocationToRegion(lat, lng, source) {
    const results = leafletPip.pointInLayer([lng, lat], geoLayer);
    if (results.length > 0) {
      const f = results[0].feature;
      selectedL3Key = f.properties.L3_KEY;
      document.getElementById('selected-region').textContent = `${selectedL3Key}: ${f.properties.US_L3NAME}`;
      map.setView([lat, lng], 8);
      highlightRegion(selectedL3Key);
      
      // Auto-fill neighboring inputs
      document.getElementById('lat-input').value = parseFloat(lat).toFixed(4);
      document.getElementById('lng-input').value = parseFloat(lng).toFixed(4);
      if (source !== 'zip') reverseLookupZip(lat, lng);
      
      renderResults(true);
    }
  }

  function useMyLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      matchLocationToRegion(pos.coords.latitude, pos.coords.longitude, 'geo');
    });
  }

  async function useZipCode() {
    const zip = document.getElementById('zip-input').value;
    if (zip.length === 5) {
      const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
      const data = await res.json();
      if (data.places) {
        matchLocationToRegion(parseFloat(data.places[0].latitude), parseFloat(data.places[0].longitude), 'zip');
      }
    }
  }

  function useCoordinates() {
    const lat = parseFloat(document.getElementById('lat-input').value);
    const lng = parseFloat(document.getElementById('lng-input').value);
    if (!isNaN(lat) && !isNaN(lng)) matchLocationToRegion(lat, lng, 'coords');
  }

  // Favorites logic
  function toggleStar(sciName) {
    const idx = starredPlants.indexOf(sciName);
    if (idx === -1) starredPlants.push(sciName);
    else starredPlants.splice(idx, 1);
    localStorage.setItem('spade_starred', JSON.stringify(starredPlants));
    renderResults(false);
  }

  function showStarred() {
    const list = document.getElementById('starred-list');
    const overlay = document.getElementById('starred-overlay');
    list.innerHTML = '';
    const items = plantData.filter(p => starredPlants.includes(p['Scientific Name']));
    if (items.length === 0) list.innerHTML = '<p style="color:white; text-align:center;">No starred plants yet.</p>';
    items.forEach(p => {
      const card = document.createElement('div'); card.className = 'plant-card';
      card.innerHTML = `<button class="star-btn active" onclick="toggleStar('${p['Scientific Name']}'); showStarred();">‚òÖ</button><h4>${p['Common Name']}</h4><p><em>${p['Scientific Name']}</em></p>`;
      list.appendChild(card);
    });
    overlay.style.display = 'block';
  }

  function renderResults(resetLimit = true) {
    if (!plantData) return; if (resetLimit) displayLimit = 10;
    const q = document.getElementById('search-box').value.toLowerCase();
    currentFilteredItems = plantData.filter(p => {
      if (selectedL3Key && p.L3_KEY !== selectedL3Key) return false;
      if (q && !((p['Common Name'] || '').toLowerCase().includes(q) || (p['Scientific Name'] || '').toLowerCase().includes(q))) return false;
      return true;
    });
    document.getElementById('results-count').textContent = `Matched ${currentFilteredItems.length} Species`;
    const list = document.getElementById('results-list'); list.innerHTML = '';
    currentFilteredItems.slice(0, displayLimit).forEach((p, idx) => {
      const isStarred = starredPlants.includes(p['Scientific Name']);
      const card = document.createElement('div'); card.className = 'plant-card';
      let soils = []; ['CLAY','SAND','GRAVEL','LOAM'].forEach(s => { if(p[s+'_SOIL'] === 'Yes') soils.push(`<span class="soil-badge">${s}</span>`); });
      let det = ''; Object.keys(p).forEach(k => { if(p[k] && p[k] !== '0') det += `<div><strong>${k.replace(/_/g,' ')}</strong><span>${p[k]}</span></div>`; });
      card.innerHTML = `<button class="star-btn ${isStarred?'active':''}" onclick="toggleStar('${p['Scientific Name']}')">${isStarred?'‚òÖ':'‚òÜ'}</button><h4>${p['Common Name']}</h4><p><em>${p['Scientific Name']}</em></p><img id="img-${idx}" class="plant-img"><div class="soil-category-container">${soils.join('')}</div><div class="card-actions"><button class="more-info-btn" onclick="toggleDetails(${idx})">Details</button><a href="${p['SOURCE_LINK_1']}" target="_blank" class="source-link">USDA Profile</a></div><div id="details-${idx}" class="details-pane">${det}</div>`;
      list.appendChild(card); loadPlantPhoto(p['Scientific Name'], idx);
    });
  }

  async function loadPlantPhoto(sciName, idx) { const img = document.getElementById(`img-${idx}`); try { const res = await fetch(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(sciName)}&rank=species`); const d = await res.json(); if (d.results?.[0]?.default_photo) img.src = d.results[0].default_photo.medium_url; else img.style.display='none'; } catch (e) { img.style.display='none'; } }
  function toggleDetails(idx) { const p = document.getElementById(`details-${idx}`); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
  function showMore() { displayLimit += 10; renderResults(false); }

  async function init() {
    Papa.parse(CSV_URL, { download: true, header: true, complete: res => { 
      plantData = res.data; 
      renderResults(); 
      loadMap(); 
    }});
  }

  async function loadMap() {
    map = L.map('map', { zoomControl: false }).setView([37.8, -96], 4); streetTiles.addTo(map);
    try {
      const res = await fetch(ECO_URL); const geo = await res.json();
      geoLayer = L.geoJSON(geo, { style: { color: '#27ae60', weight: 1, fillOpacity: 0.1 }, onEachFeature: (f, l) => {
        l.on('click', () => { 
          selectedL3Key = f.properties.L3_KEY; 
          document.getElementById('selected-region').textContent = `${selectedL3Key}: ${f.properties.US_L3NAME}`;
          highlightRegion(selectedL3Key);
          // Update Lat/Lng inputs on click
          const center = l.getBounds().getCenter();
          document.getElementById('lat-input').value = center.lat.toFixed(4);
          document.getElementById('lng-input').value = center.lng.toFixed(4);
          reverseLookupZip(center.lat, center.lng);
          renderResults(true); 
        });
      }}).addTo(map);
    } catch (e) {}
  }
  window.onload = init;
</script>
</body>
</html>