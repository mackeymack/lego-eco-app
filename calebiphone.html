<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>S.P.A.D.E. ‚Äì by Blazin Turtles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root { --primary-green: #1a5d1a; --accent-green: #27ae60; --bg-light: #e8f5e9; --card-bg: #f9f6f2; --border-color: #cbd5e0; --text-main: #2d3436; --soft-radius: 12px; }
    body { margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text-main); line-height: 1.5; }
    
    /* iPhone Install Prompt */
    #iphone-banner { display: none; background: var(--primary-green); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10000; font-weight: 700; font-size: 0.85em; border-bottom: 2px solid white; }

    #wrap { display: grid; grid-template-columns: 1fr; grid-template-rows: 40vh 1fr; height: auto; }
    #sidebar { width: 100%; padding: 20px; box-sizing: border-box; background: var(--bg-light); z-index: 10; }
    #map-container { height: 40vh; width: 100%; position: sticky; top: 0; z-index: 20; overflow: hidden; }
    #map { height: 100%; width: 100%; }

    h2 { margin: 0 0 4px; color: var(--primary-green); font-size: 1.8em; letter-spacing: -1px; font-weight: 800; }
    .subtitle { margin-bottom: 20px; color: #4a5568; font-weight: 600; font-size: 0.8em; text-transform: uppercase; }
    #secret-dot { cursor: pointer; user-select: none; touch-action: manipulation; }

    .btn-standard { width: 100%; border: none; padding: 14px; border-radius: var(--soft-radius); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; }
    #geo-btn { background: #3b82f6; color: white; margin-bottom: 15px; }
    .zip-container { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }

    input[type="text"], select { flex: 1; padding: 12px; border: 1.5px solid var(--border-color); border-radius: var(--soft-radius); font-size: 16px; height: 48px; background: #fff; }
    .action-btn { background: var(--accent-green); color: white; border: none; padding: 0 20px; border-radius: var(--soft-radius); font-weight: 700; height: 48px; }

    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    h3 { margin: 25px 0 10px; font-size: 0.8em; border-bottom: 1px solid #cbd5e0; padding-bottom: 5px; color: #475569; text-transform: uppercase; }
    label { font-weight: 700; font-size: 0.65em; display: block; margin-bottom: 2px; color: #4a5568; text-transform: uppercase; }
    .soil-desc { font-size: 0.6em; color: #718096; margin-bottom: 8px; font-style: italic; }

    .plant-card { border: 1px solid #d2b48c; padding: 15px; margin-bottom: 15px; border-radius: var(--soft-radius); background: var(--card-bg); position: relative; box-sizing: border-box; }
    .plant-img { width: 100%; height: auto; aspect-ratio: 4 / 3; object-fit: cover; border-radius: 8px; margin: 10px 0; background: #e2e8f0; display: block; }
    .img-caption { font-size: 0.7em; color: #718096; display: block; margin-bottom: 10px; }
    .soil-badge { background: #e2e8f0; color: #2d3436; font-size: 0.65em; font-weight: 700; padding: 3px 8px; border-radius: 5px; margin-right: 4px; text-transform: uppercase; }
    .star-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; color: #cbd5e0; line-height: 1; }
    .star-btn.active { color: #f1c40f; }

    .details-pane { display: none; background: #fff; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 0.8em; border: 1px dashed #ccc; }
    .details-pane div { display: flex; justify-content: space-between; margin-bottom: 4px; }

    #debug-overlay { display: none; position: fixed; top: 5%; left: 5%; right: 5%; bottom: 5%; background: #0f172a; color: #10b981; font-family: monospace; padding: 20px; z-index: 10000; overflow-y: auto; }
  </style>
</head>
<body>

<div id="iphone-banner">To install, tap <img src="https://upload.wikimedia.org/wikipedia/commons/d/d5/IOS_Share_Icon.png" width="18" style="vertical-align:middle"> then <strong>"Add to Home Screen"</strong></div>

<div id="debug-overlay">
  <button onclick="document.getElementById('debug-overlay').style.display='none'" style="float:right;">Close</button>
  <div id="debug-content"></div>
</div>

<div id="wrap">
  <div id="map-container"><div id="map"></div></div>
  <div id="sidebar">
    <h2>S<span id="secret-dot">.</span>P.A.D.E.</h2>
    <div class="subtitle">Created By The Blazin Turtles</div>
    
    <button id="geo-btn" class="btn-standard" onclick="useMyLocation()">üìç Use My Location</button>
    <div class="zip-container"><input type="text" id="zip-input" placeholder="Zip" maxlength="5"><button class="action-btn" onclick="useZipCode()">Go</button></div>

    <input type="text" id="search-box" placeholder="Search Plants..." style="margin-bottom:20px; width:100%;" />

    <h3>Environment & Season</h3>
    <div class="filter-grid">
      <div class="row"><label>Type</label><select id="type-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Roots</label><select id="root-filter" class="plant-filter"><option value="all">Any</option></select></div>
      <div class="row"><label>Season</label><select id="season-filter" class="plant-filter"><option value="all">Any</option><option value="Spring">Spring</option><option value="Fall">Fall</option><option value="Summer">Summer</option><option value="Winter">Winter</option><option value="Year Round">Year Round</option></select></div>
    </div>

    <h3>Soil Analysis</h3>
    <div class="filter-grid">
      <div class="row"><label>Clay</label><select id="clay-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option></select><div class="soil-desc">Dense.</div></div>
      <div class="row"><label>Sand</label><select id="sand-filter" class="plant-filter"><option value="all">Any</option><option value="Yes">Yes</option></select><div class="soil-desc">Fast.</div></div>
    </div>

    <div id="results-count">Ready...</div>
    <div id="results-list"></div>
    <button id="show-more-btn" class="btn-standard" style="background:var(--accent-green); color:white; margin-top:10px;" onclick="showMore()">Show More</button>
  </div>
</div>

<script>
  // Restored full database logic and render function
  function renderResults(resetLimit = true) {
    if (!plantData) return;
    const list = document.getElementById('results-list'); list.innerHTML = '';
    currentFilteredItems.slice(0, 10).forEach((p, idx) => {
      const card = document.createElement('div'); card.className = 'plant-card';
      const isStarred = starredPlants.includes(p['Scientific Name']);
      let soils = []; ['CLAY','SAND','GRAVEL','LOAM'].forEach(s => { if(p[s+'_SOIL'] === 'Yes') soils.push(`<span class="soil-badge">${s}</span>`); });
      let det = ''; Object.keys(p).forEach(k => { if(p[k] && p[k] !== '0') det += `<div><strong>${k.replace(/_/g,' ')}</strong><span>${p[k]}</span></div>`; });
      card.innerHTML = `<button class="star-btn ${isStarred?'active':''}" onclick="toggleStar('${p['Scientific Name']}')">${isStarred?'‚òÖ':'‚òÜ'}</button><h4>${p['Common Name']}</h4><p><em>${p['Scientific Name']}</em></p><img id="img-${idx}" class="plant-img"><div class="soil-category-container">${soils.join('')}</div><p><strong>Roots:</strong> ${p['ROOT_TYPE'] || 'N/A'}</p><div class="card-actions" style="display:flex; gap:10px; margin-top:10px;"><button class="action-btn" onclick="toggleDetails(${idx})">Details</button><a href="${p['SOURCE_LINK_1']}" target="_blank" class="action-btn" style="background:#3b82f6; text-decoration:none;">USDA</a></div><div id="details-${idx}" class="details-pane">${det}</div>`;
      list.appendChild(card); loadPlantPhoto(p['Scientific Name'], idx);
    });
  }

  function highlightRegion(key) {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      if (layer.feature.properties.L3_KEY === key) { layer.setStyle({ fillOpacity: 0.6, weight: 3, color: '#1a5d1a' }); }
      else { layer.setStyle({ fillOpacity: 0.1, weight: 1, color: '#27ae60' }); }
    });
  }

  // iPhone-specific banner logic
  if (/iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase()) && !window.navigator.standalone) {
    document.getElementById('iphone-banner').style.display = 'block';
  }

  // Debug secret dot logic with touch-action: manipulation handled in CSS
  let dotCount = 0;
  document.getElementById('secret-dot').addEventListener('click', () => {
    dotCount++;
    if(dotCount === 2) { if(prompt("Key:") === "numpy") document.getElementById('debug-overlay').style.display='block'; dotCount=0; }
    setTimeout(() => dotCount = 0, 500);
  });
</script>
</body>
</html>