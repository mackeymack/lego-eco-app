<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blazing Turtles ‚Äì Dig Site Plant Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (read .xlsx in the browser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; }
    h2 { margin: 8px 0 6px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; margin: 4px 6px 0 0; }
    .row { margin: 10px 0; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .small { color:#666; font-size: 12px; }
    .plant { border: 1px solid #eee; border-radius: 10px; padding: 8px; margin: 8px 0; }
    .plant b { display:block; margin-bottom: 3px; }
    code { background:#f6f6f6; padding:2px 4px; border-radius:6px; }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="sidebar">
      <h2>üê¢üî• Blazing Turtles</h2>
      <div class="small">
        Click an ecoregion on the map ‚Üí see matching plants from your Excel sheet.
      </div>

      <div class="row">
        <div><b>Selected Ecoregion</b></div>
        <div id="selectedRegion" class="pill">None</div>
      </div>

      <div class="row">
        <div><b>Plant Type Filter</b></div>
        <select id="plantTypeFilter">
          <option value="">(All Plant Types)</option>
        </select>
      </div>

      <div class="row">
        <div><b>Search (Common or Scientific name)</b></div>
        <input id="searchBox" placeholder="type to filter‚Ä¶" />
      </div>

      <div class="row">
        <div><b>Results</b> <span class="small" id="resultCount"></span></div>
        <div id="results"></div>
      </div>

      <hr/>
      <div class="small" id="status">Loading‚Ä¶</div>
      <div class="small" id="debug"></div>
    </div>

    <div id="map"></div>
  </div>

<script>
  // -----------------------------
  // ‚úÖ YOUR FILES (no renaming)
  // -----------------------------
  const ECOREGIONS_URL = 'assets/us_eco_l3_state_boundaries.json';
  const DATABASE_XLSX_URL = 'assets/Database-Deleted-Catagories.xlsx';

  // If your files are NOT in /assets, change to:
  // const ECOREGIONS_URL = 'us_eco_l3_state_boundaries.json';
  // const DATABASE_XLSX_URL = 'Database-Deleted-Catagories.xlsx';

  // -----------------------------
  // Map setup
  // -----------------------------
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // -----------------------------
  // App state
  // -----------------------------
  let plants = [];            // all plant rows
  let plantsByL3 = new Map(); // L3_KEY -> array of plant rows
  let selectedL3Key = null;
  let selectedL3Name = null;

  // UI elements
  const elSelected = document.getElementById('selectedRegion');
  const elTypeFilter = document.getElementById('plantTypeFilter');
  const elSearch = document.getElementById('searchBox');
  const elResults = document.getElementById('results');
  const elCount = document.getElementById('resultCount');
  const elStatus = document.getElementById('status');
  const elDebug = document.getElementById('debug');

  function setStatus(msg) { elStatus.textContent = msg; }
  function normalizeKey(s) { return String(s ?? '').toLowerCase().replace(/[\s_\-]+/g, ''); }
  function normText(s) { return String(s ?? '').toLowerCase().trim(); }

  // Find a column even if you renamed it.
  // Example: "Plant Type", "plant_type", "PlantType" all match.
  function findColumn(headers, wanted) {
    const w = normalizeKey(wanted);
    for (const h of headers) if (normalizeKey(h) === w) return h;

    // Some common alternate names:
    const alts = {
      l3_key: ['l3key','l3','ecoregionkey'],
      ecoregion: ['us_l3name','l3name','regionname'],
      plant_type: ['planttype','type'],
      scientific_name: ['scientificname','sciname','botanicalname','scientific'],
      common_name: ['commonname','name'],
      root_type: ['roottype'],
      root_depth: ['rootdepth','maturerootdepth','maximumrootdepth','maxrootdepth']
    }[w] || [];

    for (const alt of alts) {
      for (const h of headers) if (normalizeKey(h) === alt) return h;
    }
    return null;
  }

  function rebuildTypeDropdown() {
    // reset to default option
    elTypeFilter.innerHTML = '<option value="">(All Plant Types)</option>';
    const types = new Set(plants.map(p => p.plantType).filter(Boolean));
    [...types].sort((a,b)=>a.localeCompare(b)).forEach(t => {
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      elTypeFilter.appendChild(opt);
    });
  }

  function indexPlantsByL3() {
    plantsByL3 = new Map();
    for (const p of plants) {
      if (!p.l3Key) continue;
      if (!plantsByL3.has(p.l3Key)) plantsByL3.set(p.l3Key, []);
      plantsByL3.get(p.l3Key).push(p);
    }
  }

  function renderResults() {
    elResults.innerHTML = '';
    elCount.textContent = '';

    if (!selectedL3Key) {
      elResults.innerHTML = '<div class="small">Click an ecoregion to see plants.</div>';
      return;
    }

    const typeFilter = elTypeFilter.value;
    const q = normText(elSearch.value);

    const list = (plantsByL3.get(selectedL3Key) || []).filter(p => {
      if (typeFilter && p.plantType !== typeFilter) return false;
      if (!q) return true;
      return normText(p.commonName).includes(q) || normText(p.scientificName).includes(q);
    });

    const shown = list.slice(0, 80);
    elCount.textContent = `(${list.length} matches${list.length > shown.length ? `, showing first ${shown.length}` : ''})`;

    for (const p of shown) {
      const div = document.createElement('div');
      div.className = 'plant';
      div.innerHTML = `
        <b>${p.commonName || '(no common name)'}</b>
        <div class="small"><i>${p.scientificName || '(no scientific name)'}</i></div>
        <div class="small">
          Plant Type: ${p.plantType || '‚Äî'}<br/>
          Root Type: ${p.rootType || '‚Äî'}<br/>
          Root Depth: ${p.rootDepth || '‚Äî'}
        </div>
      `;
      elResults.appendChild(div);
    }
  }

  // -----------------------------
  // Load Excel (.xlsx) in browser
  // -----------------------------
  async function loadPlantDatabaseXLSX() {
    setStatus('Loading Excel plant database‚Ä¶');

    const res = await fetch(DATABASE_XLSX_URL);
    if (!res.ok) throw new Error(`Failed to load Excel: ${res.status}`);

    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });

    const sheetName = wb.SheetNames[0]; // ‚úÖ auto-pick first sheet
    const ws = wb.Sheets[sheetName];
    if (!ws) throw new Error('Excel has no readable sheets.');

    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    if (!rows.length) throw new Error('Excel sheet has no rows.');

    const headers = Object.keys(rows[0]);

    // Detect columns (handles renamed headers)
    const cL3   = findColumn(headers, 'L3_KEY');
    const cEco  = findColumn(headers, 'Ecoregion');
    const cType = findColumn(headers, 'Plant Type');
    const cSci  = findColumn(headers, 'Scientific Name');
    const cCom  = findColumn(headers, 'Common Name');
    const cRT   = findColumn(headers, 'ROOT_TYPE');
    const cRD   = findColumn(headers, 'ROOT_DEPTH');

    elDebug.innerHTML = `
      <div><b>Detected Excel sheet:</b> ${sheetName}</div>
      <div class="small">
        Columns used: 
        <br/>L3_KEY = <code>${cL3 || 'NOT FOUND'}</code>
        <br/>Ecoregion = <code>${cEco || 'NOT FOUND'}</code>
        <br/>Plant Type = <code>${cType || 'NOT FOUND'}</code>
        <br/>Scientific Name = <code>${cSci || 'NOT FOUND'}</code>
        <br/>Common Name = <code>${cCom || 'NOT FOUND'}</code>
        <br/>ROOT_TYPE = <code>${cRT || 'NOT FOUND'}</code>
        <br/>ROOT_DEPTH = <code>${cRD || 'NOT FOUND'}</code>
      </div>
    `;

    // Build plant objects
    plants = rows.map(r => ({
      l3Key: cL3 ? String(r[cL3]).trim() : '',
      ecoregion: cEco ? String(r[cEco]).trim() : '',
      plantType: cType ? String(r[cType]).trim() : '',
      scientificName: cSci ? String(r[cSci]).trim() : '',
      commonName: cCom ? String(r[cCom]).trim() : '',
      rootType: cRT ? String(r[cRT]).trim() : '',
      rootDepth: cRD ? String(r[cRD]).trim() : ''
    }));

    indexPlantsByL3();
    rebuildTypeDropdown();

    setStatus(`Loaded ${plants.length.toLocaleString()} rows from Excel.`);
  }

  // ----------
